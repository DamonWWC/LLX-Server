# 林龍香大米商城 - API服务独立部署方案总结

## 📦 已创建的部署文件

### 1. Docker配置文件
- ✅ **docker-compose.api-only.yml** - API服务专用Docker Compose配置
  - 仅包含API服务
  - 配置外部数据库和Redis连接
  - 包含健康检查和资源限制

### 2. 环境配置文件
- ✅ **env.api-only.example** - API服务专用环境变量配置示例
  - 详细的配置说明
  - 数据库连接字符串配置
  - Redis连接字符串配置
  - 性能和资源配置

### 3. 部署脚本
- ✅ **LLX.Server/scripts/deploy-api-only.ps1** - PowerShell一键部署脚本
  - 自动化部署流程
  - 环境检查
  - 配置验证
  - 服务启动和验证

### 4. 部署文档
- ✅ **doc/API服务独立部署指南.md** - 详细部署指南（50+页）
  - 前提条件说明
  - 三种部署方式
  - 环境变量配置详解
  - 故障排查指南
  - 日常维护操作

- ✅ **doc/API服务快速部署指南.md** - 快速入门指南
  - 5分钟快速部署
  - 简化的配置说明
  - 常见问题快速解决

---

## 🚀 部署方式对比

### 方式一：自动化脚本部署（推荐）⭐⭐⭐⭐⭐

**适用场景**：首次部署、日常更新

**命令**：
```powershell
.\LLX.Server\scripts\deploy-api-only.ps1
```

**优点**：
- ✅ 完全自动化
- ✅ 自动检查环境
- ✅ 自动验证配置
- ✅ 友好的错误提示

**使用场景**：
- 首次部署
- 更新代码后重新部署
- 配置变更后重新部署

---

### 方式二：Docker Compose部署 ⭐⭐⭐⭐

**适用场景**：熟悉Docker Compose的用户

**命令**：
```powershell
docker-compose -f docker-compose.api-only.yml up -d
```

**优点**：
- ✅ 标准Docker Compose流程
- ✅ 易于集成到CI/CD
- ✅ 配置文件化管理

**使用场景**：
- 集成到自动化部署流程
- 多环境部署
- 需要自定义配置

---

### 方式三：Docker命令部署 ⭐⭐⭐

**适用场景**：熟悉Docker命令的用户

**命令**：
```powershell
docker run -d --name llxrice_api -p 8080:8080 -e "..." llxrice/api:latest
```

**优点**：
- ✅ 完全控制
- ✅ 灵活配置
- ✅ 适合测试环境

**使用场景**：
- 快速测试
- 临时部署
- 需要特殊配置

---

## 📝 核心配置说明

### 数据库连接配置

**完整格式**：
```bash
Host={IP地址};Port={端口};Database={数据库名};Username={用户名};Password={密码};Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30
```

**必需参数**：
- `Host`: 数据库服务器地址
- `Port`: 数据库端口（PostgreSQL默认5432）
- `Database`: 数据库名称（llxrice）
- `Username`: 数据库用户名
- `Password`: 数据库密码

**性能参数**：
- `Pooling=true`: 启用连接池
- `Minimum Pool Size=5`: 最小连接数
- `Maximum Pool Size=100`: 最大连接数
- `Command Timeout=30`: 命令超时时间（秒）

**配置示例**：
```bash
# 本地开发环境
DB_CONNECTION_STRING=Host=localhost;Port=5432;Database=llxrice;Username=postgres;Password=postgres;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30

# 生产环境
DB_CONNECTION_STRING=Host=192.168.1.100;Port=5432;Database=llxrice;Username=llxrice_user;Password=StrongPassword123!;Pooling=true;Minimum Pool Size=10;Maximum Pool Size=200;Command Timeout=30
```

---

### Redis连接配置

**完整格式**：
```bash
{IP地址}:{端口},password={密码},ssl={是否SSL},abortConnect=false
```

**必需参数**：
- `IP地址:端口`: Redis服务器地址和端口（默认6379）
- `password`: Redis密码（如果有）
- `ssl`: 是否使用SSL连接
- `abortConnect=false`: 连接失败时不中止应用

**配置示例**：
```bash
# 本地开发环境（无密码）
REDIS_CONNECTION_STRING=localhost:6379,ssl=false,abortConnect=false

# 生产环境（有密码）
REDIS_CONNECTION_STRING=192.168.1.101:6379,password=RedisPass123!,ssl=false,abortConnect=false

# 云环境（使用SSL）
REDIS_CONNECTION_STRING=myredis.cache.amazonaws.com:6379,password=CloudRedisPass,ssl=true,abortConnect=false
```

---

## ✅ 部署流程图

```
┌─────────────────────────────────────────────┐
│  1. 准备工作                                 │
│  - 确认PostgreSQL和Redis已运行              │
│  - 获取连接信息                              │
│  - 安装Docker                                │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│  2. 配置环境变量                             │
│  - 复制 env.api-only.example 为 .env       │
│  - 配置数据库连接字符串                      │
│  - 配置Redis连接字符串                       │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│  3. 运行部署脚本                             │
│  - 执行 deploy-api-only.ps1                 │
│  - 自动检查环境                              │
│  - 自动编译项目                              │
│  - 自动构建镜像                              │
│  - 自动启动服务                              │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│  4. 验证部署                                 │
│  - 检查容器状态                              │
│  - 访问健康检查                              │
│  - 测试API接口                               │
│  - 查看Swagger文档                           │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│  5. 部署完成 ✅                              │
│  - 服务正常运行                              │
│  - 可以开始使用                              │
└─────────────────────────────────────────────┘
```

---

## 🎯 快速开始（3步）

### 步骤1：配置连接信息
```powershell
cd E:\资料\学习代码\LLX.Server
copy env.api-only.example .env
notepad .env
```

**修改两行**：
```bash
DB_CONNECTION_STRING=Host=你的数据库IP;Port=5432;Database=llxrice;Username=用户名;Password=密码;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30

REDIS_CONNECTION_STRING=你的RedisIP:6379,password=Redis密码,ssl=false,abortConnect=false
```

### 步骤2：运行部署
```powershell
.\LLX.Server\scripts\deploy-api-only.ps1
```

### 步骤3：验证部署
```powershell
curl http://localhost:8080/health
```

看到 `{"status":"Healthy"}` 表示成功！🎉

---

## 🔧 常用运维命令

### 日常操作

```powershell
# 查看容器状态
docker ps | findstr llxrice_api

# 查看日志
docker logs -f llxrice_api

# 重启服务
docker restart llxrice_api

# 停止服务
docker stop llxrice_api

# 删除容器
docker rm -f llxrice_api

# 查看资源使用
docker stats llxrice_api
```

### 更新部署

```powershell
# 使用脚本更新（推荐）
.\LLX.Server\scripts\deploy-api-only.ps1 -Build -Force

# 手动更新
docker stop llxrice_api
docker rm llxrice_api
docker build -f LLX.Server/Dockerfile -t llxrice/api:latest .
docker-compose -f docker-compose.api-only.yml up -d
```

### 故障排查

```powershell
# 查看最近的日志
docker logs --tail 100 llxrice_api

# 查看完整日志
docker logs llxrice_api > api.log

# 进入容器
docker exec -it llxrice_api bash

# 测试数据库连接
Test-NetConnection -ComputerName 192.168.1.100 -Port 5432

# 测试Redis连接
Test-NetConnection -ComputerName 192.168.1.101 -Port 6379

# 检查端口占用
netstat -ano | findstr :8080
```

---

## 📚 文档索引

### 快速入门
- **API服务快速部署指南.md** - 5分钟快速部署
  - 简化流程
  - 快速配置
  - 常见问题

### 详细指南
- **API服务独立部署指南.md** - 完整部署文档
  - 详细的前提条件
  - 三种部署方式
  - 完整的配置说明
  - 故障排查指南
  - 日常维护操作

### 配置文件
- **docker-compose.api-only.yml** - Docker Compose配置
- **env.api-only.example** - 环境变量配置模板

### 部署脚本
- **deploy-api-only.ps1** - PowerShell部署脚本
  - 自动化部署
  - 环境检查
  - 配置验证

---

## ⚠️ 重要提示

### 安全建议

1. **数据库密码**
   - ❌ 不要使用弱密码
   - ✅ 使用强密码（字母+数字+特殊字符）
   - ✅ 定期更换密码

2. **Redis密码**
   - ❌ 不要使用空密码
   - ✅ 设置强密码
   - ✅ 限制访问IP

3. **网络安全**
   - ✅ 配置防火墙规则
   - ✅ 只开放必要端口
   - ✅ 使用VPN或内网访问

4. **环境变量**
   - ❌ 不要将.env文件提交到Git
   - ✅ 妥善保管配置文件
   - ✅ 不同环境使用不同配置

### 性能建议

1. **资源配置**
   - 根据实际负载调整内存限制
   - 根据CPU使用情况调整CPU限制

2. **连接池配置**
   - 根据并发量调整连接池大小
   - 监控连接池使用情况

3. **缓存策略**
   - 合理配置Redis内存
   - 选择合适的缓存淘汰策略

---

## 🎉 总结

您现在拥有完整的API服务独立部署方案：

✅ **3种部署方式**
- 自动化脚本部署（最简单）
- Docker Compose部署（标准方式）
- Docker命令部署（灵活方式）

✅ **完整的文档支持**
- 快速入门指南（5分钟上手）
- 详细部署指南（50+页完整文档）
- 配置示例和模板

✅ **自动化工具**
- 一键部署脚本
- 自动环境检查
- 自动配置验证

✅ **运维支持**
- 常用命令手册
- 故障排查指南
- 日常维护操作

---

**现在您可以快速部署API服务到任何已有PostgreSQL和Redis的环境中！**

如有任何问题，请参考详细文档或查看日志排查。
