# æ—é¾é¦™å¤§ç±³å•†åŸ - åç«¯æœåŠ¡å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#ç³»ç»Ÿæ¶æ„è®¾è®¡)
2. [æŠ€æœ¯æ ˆè¯´æ˜](#æŠ€æœ¯æ ˆè¯´æ˜)
3. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
4. [APIæ¥å£è®¾è®¡](#apiæ¥å£è®¾è®¡)
5. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
6. [æ ¸å¿ƒä»£ç å®ç°](#æ ¸å¿ƒä»£ç å®ç°)
7. [Redisç¼“å­˜ç­–ç•¥](#redisç¼“å­˜ç­–ç•¥)
8. [éƒ¨ç½²æ–¹æ¡ˆ](#éƒ¨ç½²æ–¹æ¡ˆ)
9. [å¼€å‘è§„èŒƒ](#å¼€å‘è§„èŒƒ)
10. [å°ç¨‹åºå¯¹æ¥è¯´æ˜](#å°ç¨‹åºå¯¹æ¥è¯´æ˜)

---

## ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¾®ä¿¡å°ç¨‹åºå®¢æˆ·ç«¯                       â”‚
â”‚    (pages/index, checkout, orders, address, shipping)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTPS (443)
                       â”‚ API è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nginx åå‘ä»£ç†å±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  - HTTPS/SSL ç»ˆæ­¢                                    â”‚   â”‚
â”‚  â”‚  - è´Ÿè½½å‡è¡¡                                          â”‚   â”‚
â”‚  â”‚  - é™æ€èµ„æºæœåŠ¡                                      â”‚   â”‚
â”‚  â”‚  - è¯·æ±‚é™æµ                                          â”‚   â”‚
â”‚  â”‚  - Gzip å‹ç¼©                                         â”‚   â”‚
â”‚  â”‚  - è®¿é—®æ—¥å¿—                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP (8080)
                       â”‚ å†…éƒ¨è½¬å‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                .NET 8 Minimal API å±‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Endpoints  â”‚   Services   â”‚   Repositories           â”‚ â”‚
â”‚  â”‚  (è·¯ç”±ç«¯ç‚¹)   â”‚  (ä¸šåŠ¡é€»è¾‘)  â”‚  (æ•°æ®è®¿é—®)              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                         â”‚
         â”‚ EF Core                                 â”‚ StackExchange.Redis
         â”‚                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL æ•°æ®åº“          â”‚     â”‚    Redis ç¼“å­˜æœåŠ¡       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚  - å•†å“åˆ—è¡¨ç¼“å­˜         â”‚
â”‚  â”‚ Products â”‚ Orders   â”‚    â”‚     â”‚  - è¿è´¹é…ç½®ç¼“å­˜         â”‚
â”‚  â”‚ Addressesâ”‚ Shipping â”‚    â”‚     â”‚  - ä¼šè¯ç¼“å­˜(é¢„ç•™)       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ç‰¹ç‚¹

- **Nginx åå‘ä»£ç†**: HTTPS ç»ˆæ­¢ã€è´Ÿè½½å‡è¡¡ã€è¯·æ±‚é™æµã€é™æ€èµ„æºæœåŠ¡
- **Minimal API**: ä½¿ç”¨ .NET 8 æœ€å° APIï¼Œä»£ç ç®€æ´é«˜æ•ˆ
- **åˆ†å±‚æ¶æ„**: Endpoints â†’ Services â†’ Repositoriesï¼ŒèŒè´£æ¸…æ™°
- **ç¼“å­˜ä¼˜åŒ–**: Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œæå‡æ€§èƒ½
- **æ— çŠ¶æ€è®¾è®¡**: API æ— çŠ¶æ€ï¼Œä¾¿äºæ¨ªå‘æ‰©å±•
- **å®¹å™¨åŒ–éƒ¨ç½²**: Docker ä¸€é”®éƒ¨ç½²ï¼Œç¯å¢ƒä¸€è‡´æ€§å¥½

### Nginx åå‘ä»£ç†åŠŸèƒ½

#### 1. HTTPS/SSL ç»ˆæ­¢
- åœ¨ Nginx å±‚å¤„ç† HTTPS åŠ å¯†/è§£å¯†
- åç«¯ API ä½¿ç”¨ HTTPï¼Œç®€åŒ–é…ç½®
- æ”¯æŒè‡ªåŠ¨ç»­æœŸ SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰

#### 2. è´Ÿè½½å‡è¡¡
- æ”¯æŒå¤šä¸ªåç«¯å®ä¾‹
- è½®è¯¢ã€IP Hashã€æœ€å°‘è¿æ¥ç­‰ç­–ç•¥
- å¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨å‰”é™¤æ•…éšœèŠ‚ç‚¹

#### 3. é™æ€èµ„æºæœåŠ¡
- ç›´æ¥æœåŠ¡é™æ€æ–‡ä»¶ï¼ˆå¦‚å›¾ç‰‡ã€æ–‡æ¡£ï¼‰
- å‡è½»åç«¯å‹åŠ›
- æ”¯æŒæµè§ˆå™¨ç¼“å­˜

#### 4. è¯·æ±‚é™æµ
- é˜²æ­¢ DDoS æ”»å‡»
- é™åˆ¶å• IP è¯·æ±‚é¢‘ç‡
- ä¿æŠ¤åç«¯æœåŠ¡ç¨³å®šæ€§

#### 5. Gzip å‹ç¼©
- å‹ç¼©å“åº”å†…å®¹
- å‡å°‘ç½‘ç»œä¼ è¾“é‡
- æå‡å“åº”é€Ÿåº¦

#### 6. è®¿é—®æ—¥å¿—
- è®°å½•æ‰€æœ‰è¯·æ±‚
- ä¾¿äºé—®é¢˜æ’æŸ¥
- æ”¯æŒæ—¥å¿—åˆ†æ

---

## æŠ€æœ¯æ ˆè¯´æ˜

### åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Nginx | 1.24+ | åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€HTTPS |
| .NET | 8.0 | åç«¯æ¡†æ¶ |
| ASP.NET Core | 8.0 | Web API æ¡†æ¶ |
| Entity Framework Core | 8.0 | ORM æ¡†æ¶ |
| PostgreSQL | 16 | å…³ç³»æ•°æ®åº“ |
| Npgsql | 8.0 | PostgreSQL é©±åŠ¨ |
| Redis | 7.2 | ç¼“å­˜æœåŠ¡ |
| StackExchange.Redis | 2.7 | Redis å®¢æˆ·ç«¯ |
| Serilog | 3.1 | ç»“æ„åŒ–æ—¥å¿— |
| Swagger/OpenAPI | 6.5 | API æ–‡æ¡£ |
| Docker | 24.0+ | å®¹å™¨åŒ–éƒ¨ç½² |
| Docker Compose | 2.20+ | å®¹å™¨ç¼–æ’ |

### ä¸ºä»€ä¹ˆé€‰æ‹©è¿™äº›æŠ€æœ¯ï¼Ÿ

#### 1. Nginx
- âœ… **é«˜æ€§èƒ½**: å¤„ç†é«˜å¹¶å‘è¯·æ±‚ï¼Œèµ„æºæ¶ˆè€—ä½
- âœ… **æˆç†Ÿç¨³å®š**: å…¨çƒæœ€æµè¡Œçš„ Web æœåŠ¡å™¨ä¹‹ä¸€
- âœ… **åŠŸèƒ½ä¸°å¯Œ**: åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€SSLã€ç¼“å­˜
- âœ… **æ˜“äºé…ç½®**: é…ç½®æ–‡ä»¶ç®€æ´ï¼Œå­¦ä¹ æˆæœ¬ä½

#### 2. .NET 8 Minimal API
- âœ… **æ€§èƒ½ä¼˜å¼‚**: æ¯”ä¼ ç»Ÿ Controller æ€§èƒ½æå‡ 20%+
- âœ… **ä»£ç ç®€æ´**: å‡å°‘æ ·æ¿ä»£ç ï¼Œå¼€å‘æ•ˆç‡é«˜
- âœ… **åŸç”Ÿæ”¯æŒ**: å¾®è½¯å®˜æ–¹æ¨èçš„è½»é‡çº§ API æ–¹æ¡ˆ
- âœ… **æ˜“äºæ‰©å±•**: æ”¯æŒä¸­é—´ä»¶ã€è¿‡æ»¤å™¨ç­‰é«˜çº§åŠŸèƒ½

#### 3. PostgreSQL
- âœ… **å¼€æºå…è´¹**: å®Œå…¨å¼€æºï¼Œæ— ç‰ˆæƒé—®é¢˜
- âœ… **æ€§èƒ½å¼ºå¤§**: æ”¯æŒé«˜å¹¶å‘ï¼Œäº‹åŠ¡å¤„ç†èƒ½åŠ›å¼º
- âœ… **åŠŸèƒ½ä¸°å¯Œ**: æ”¯æŒ JSONã€å…¨æ–‡æœç´¢ç­‰é«˜çº§ç‰¹æ€§
- âœ… **è·¨å¹³å°**: æ”¯æŒ Linux/Windows/macOS

#### 4. Redis
- âœ… **é«˜æ€§èƒ½**: å†…å­˜å­˜å‚¨ï¼Œè¯»å†™é€Ÿåº¦å¿«
- âœ… **æ•°æ®ç»“æ„ä¸°å¯Œ**: æ”¯æŒ Stringã€Hashã€Listã€Set ç­‰
- âœ… **æŒä¹…åŒ–**: æ”¯æŒ RDB å’Œ AOF ä¸¤ç§æŒä¹…åŒ–æ–¹å¼
- âœ… **åˆ†å¸ƒå¼æ”¯æŒ**: æ”¯æŒä¸»ä»å¤åˆ¶ã€é›†ç¾¤æ¨¡å¼

---

## æ•°æ®åº“è®¾è®¡

### ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Products      â”‚         â”‚   Addresses     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Id (PK)         â”‚         â”‚ Id (PK)         â”‚
â”‚ Name            â”‚         â”‚ Name            â”‚
â”‚ Price           â”‚         â”‚ Phone           â”‚
â”‚ Unit            â”‚         â”‚ Province        â”‚
â”‚ Weight          â”‚         â”‚ City            â”‚
â”‚ Image           â”‚         â”‚ District        â”‚
â”‚ Quantity        â”‚         â”‚ Detail          â”‚
â”‚ CreatedAt       â”‚         â”‚ IsDefault       â”‚
â”‚ UpdatedAt       â”‚         â”‚ CreatedAt       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ UpdatedAt       â”‚
         â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
         â””â”€â”€â”€â”‚   Orders        â”‚â”€â”€â”€â”€â”˜
             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
             â”‚ Id (PK)         â”‚
             â”‚ OrderNo         â”‚
             â”‚ AddressId (FK)  â”‚
             â”‚ TotalRicePrice  â”‚
             â”‚ TotalWeight     â”‚
             â”‚ ShippingRate    â”‚
             â”‚ TotalShipping   â”‚
             â”‚ GrandTotal      â”‚
             â”‚ PaymentStatus   â”‚
             â”‚ Status          â”‚
             â”‚ CreatedAt       â”‚
             â”‚ UpdatedAt       â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 1:N
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   OrderItems    â”‚
             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
             â”‚ Id (PK)         â”‚
             â”‚ OrderId (FK)    â”‚
             â”‚ ProductId (FK)  â”‚
             â”‚ ProductName     â”‚
             â”‚ ProductPrice    â”‚
             â”‚ ProductUnit     â”‚
             â”‚ ProductWeight   â”‚
             â”‚ Quantity        â”‚
             â”‚ Subtotal        â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ShippingRates   â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Id (PK)         â”‚
â”‚ Province        â”‚
â”‚ Rate            â”‚
â”‚ CreatedAt       â”‚
â”‚ UpdatedAt       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡¨ç»“æ„è¯´æ˜

#### 1. Productsï¼ˆå•†å“è¡¨ï¼‰

```sql
CREATE TABLE "Products" (
    "Id" SERIAL PRIMARY KEY,
    "Name" VARCHAR(100) NOT NULL,
    "Price" DECIMAL(10,2) NOT NULL,
    "Unit" VARCHAR(20) NOT NULL,
    "Weight" DECIMAL(10,2) NOT NULL,
    "Image" TEXT,
    "Quantity" INT DEFAULT 0,
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX "idx_products_name" ON "Products"("Name");
```

**å­—æ®µè¯´æ˜**:
- `Name`: å•†å“åç§°ï¼Œå¦‚"ç¨»èŠ±é¦™"ã€"é•¿ç²’é¦™"
- `Price`: å•ä»·ï¼ˆå…ƒï¼‰
- `Unit`: å•ä½ï¼ˆè¢‹/ç®±ï¼‰
- `Weight`: å•ä½é‡é‡ï¼ˆæ–¤ï¼‰
- `Image`: å•†å“å›¾ç‰‡ï¼ˆBase64 æˆ– URLï¼‰
- `Quantity`: åº“å­˜æ•°é‡ï¼ˆæš‚æœªä½¿ç”¨ï¼Œé¢„ç•™ï¼‰

#### 2. Addressesï¼ˆæ”¶è´§åœ°å€è¡¨ï¼‰

```sql
CREATE TABLE "Addresses" (
    "Id" SERIAL PRIMARY KEY,
    "Name" VARCHAR(50) NOT NULL,
    "Phone" VARCHAR(20) NOT NULL,
    "Province" VARCHAR(50) NOT NULL,
    "City" VARCHAR(50) NOT NULL,
    "District" VARCHAR(50),
    "Detail" VARCHAR(200) NOT NULL,
    "IsDefault" BOOLEAN DEFAULT FALSE,
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX "idx_addresses_default" ON "Addresses"("IsDefault");
CREATE INDEX "idx_addresses_phone" ON "Addresses"("Phone");
```

**å­—æ®µè¯´æ˜**:
- `IsDefault`: æ˜¯å¦é»˜è®¤åœ°å€

#### 3. Ordersï¼ˆè®¢å•è¡¨ï¼‰

```sql
CREATE TABLE "Orders" (
    "Id" SERIAL PRIMARY KEY,
    "OrderNo" VARCHAR(50) UNIQUE NOT NULL,
    "AddressId" INT NOT NULL,
    "TotalRicePrice" DECIMAL(10,2) NOT NULL,
    "TotalWeight" DECIMAL(10,2) NOT NULL,
    "ShippingRate" DECIMAL(10,2) NOT NULL,
    "TotalShipping" DECIMAL(10,2) NOT NULL,
    "GrandTotal" DECIMAL(10,2) NOT NULL,
    "PaymentStatus" VARCHAR(20) DEFAULT 'æœªä»˜æ¬¾',
    "Status" VARCHAR(20) NOT NULL DEFAULT 'å¾…å‘è´§',
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT "fk_orders_address" FOREIGN KEY ("AddressId") 
        REFERENCES "Addresses"("Id") ON DELETE RESTRICT
);

CREATE INDEX "idx_orders_orderno" ON "Orders"("OrderNo");
CREATE INDEX "idx_orders_status" ON "Orders"("Status");
CREATE INDEX "idx_orders_createdat" ON "Orders"("CreatedAt" DESC);
```

**å­—æ®µè¯´æ˜**:
- `OrderNo`: è®¢å•å·ï¼Œæ ¼å¼: ORD + æ—¶é—´æˆ³
- `TotalRicePrice`: å•†å“æ€»ä»·
- `TotalWeight`: æ€»é‡é‡ï¼ˆæ–¤ï¼‰
- `ShippingRate`: è¿è´¹å•ä»·ï¼ˆå…ƒ/æ–¤ï¼‰
- `TotalShipping`: è¿è´¹æ€»è®¡
- `GrandTotal`: è®¢å•æ€»é‡‘é¢
- `PaymentStatus`: ä»˜æ¬¾çŠ¶æ€ï¼ˆå·²ä»˜æ¬¾/æœªä»˜æ¬¾ï¼‰
- `Status`: è®¢å•çŠ¶æ€ï¼ˆå¾…ä»˜æ¬¾/å¾…å‘è´§/å·²å‘è´§/å·²å®Œæˆ/å·²å–æ¶ˆï¼‰

#### 4. OrderItemsï¼ˆè®¢å•æ˜ç»†è¡¨ï¼‰

```sql
CREATE TABLE "OrderItems" (
    "Id" SERIAL PRIMARY KEY,
    "OrderId" INT NOT NULL,
    "ProductId" INT NOT NULL,
    "ProductName" VARCHAR(100) NOT NULL,
    "ProductPrice" DECIMAL(10,2) NOT NULL,
    "ProductUnit" VARCHAR(20) NOT NULL,
    "ProductWeight" DECIMAL(10,2) NOT NULL,
    "Quantity" INT NOT NULL,
    "Subtotal" DECIMAL(10,2) NOT NULL,
    
    CONSTRAINT "fk_orderitems_order" FOREIGN KEY ("OrderId") 
        REFERENCES "Orders"("Id") ON DELETE CASCADE,
    CONSTRAINT "fk_orderitems_product" FOREIGN KEY ("ProductId") 
        REFERENCES "Products"("Id") ON DELETE RESTRICT
);

CREATE INDEX "idx_orderitems_orderid" ON "OrderItems"("OrderId");
CREATE INDEX "idx_orderitems_productid" ON "OrderItems"("ProductId");
```

**è¯´æ˜**: å†—ä½™å­˜å‚¨å•†å“ä¿¡æ¯ï¼Œé¿å…å•†å“ä¿®æ”¹åå½±å“å†å²è®¢å•

#### 5. ShippingRatesï¼ˆè¿è´¹é…ç½®è¡¨ï¼‰

```sql
CREATE TABLE "ShippingRates" (
    "Id" SERIAL PRIMARY KEY,
    "Province" VARCHAR(50) NOT NULL UNIQUE,
    "Rate" DECIMAL(10,2) NOT NULL,
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**è¯´æ˜**: æŒ‰çœä»½é…ç½®ä¸åŒè¿è´¹å•ä»·ï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´

---

## APIæ¥å£è®¾è®¡

### ç»Ÿä¸€å“åº”æ ¼å¼

```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {},
  "timestamp": "2025-10-17T10:30:00Z"
}
```

### é”™è¯¯å“åº”æ ¼å¼

```json
{
  "success": false,
  "message": "é”™è¯¯ä¿¡æ¯",
  "errors": ["è¯¦ç»†é”™è¯¯1", "è¯¦ç»†é”™è¯¯2"],
  "timestamp": "2025-10-17T10:30:00Z"
}
```

### æ¥å£åˆ—è¡¨

#### 1. å•†å“ç®¡ç†

```http
# è·å–æ‰€æœ‰å•†å“
GET /api/products
Response: ApiResponse<List<ProductDto>>

# è·å–å•ä¸ªå•†å“
GET /api/products/{id}
Response: ApiResponse<ProductDto>

# åˆ›å»ºå•†å“
POST /api/products
Body: CreateProductDto
Response: ApiResponse<ProductDto>

# æ›´æ–°å•†å“
PUT /api/products/{id}
Body: UpdateProductDto
Response: ApiResponse<ProductDto>

# åˆ é™¤å•†å“
DELETE /api/products/{id}
Response: ApiResponse<bool>
```

#### 2. åœ°å€ç®¡ç†

```http
# è·å–æ‰€æœ‰åœ°å€
GET /api/addresses
Response: ApiResponse<List<AddressDto>>

# è·å–å•ä¸ªåœ°å€
GET /api/addresses/{id}
Response: ApiResponse<AddressDto>

# åˆ›å»ºåœ°å€
POST /api/addresses
Body: CreateAddressDto
Response: ApiResponse<AddressDto>

# æ›´æ–°åœ°å€
PUT /api/addresses/{id}
Body: UpdateAddressDto
Response: ApiResponse<AddressDto>

# åˆ é™¤åœ°å€
DELETE /api/addresses/{id}
Response: ApiResponse<bool>

# è®¾ç½®é»˜è®¤åœ°å€
PUT /api/addresses/{id}/set-default
Response: ApiResponse<bool>

# æ™ºèƒ½è¯†åˆ«åœ°å€
POST /api/addresses/parse
Body: { "text": "å¼ ä¸‰ 13800138000 å¹¿ä¸œçœæ·±åœ³å¸‚..." }
Response: ApiResponse<ParsedAddressDto>
```

#### 3. è®¢å•ç®¡ç†

```http
# è·å–è®¢å•åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
GET /api/orders?page=1&pageSize=10&status=å¾…å‘è´§
Response: ApiResponse<PagedResult<OrderDto>>

# è·å–è®¢å•è¯¦æƒ…
GET /api/orders/{id}
Response: ApiResponse<OrderDetailDto>

# åˆ›å»ºè®¢å•
POST /api/orders
Body: CreateOrderDto
Response: ApiResponse<OrderDto>

# æ›´æ–°è®¢å•çŠ¶æ€
PUT /api/orders/{id}/status
Body: { "status": "å·²å‘è´§" }
Response: ApiResponse<bool>

# åˆ é™¤è®¢å•
DELETE /api/orders/{id}
Response: ApiResponse<bool>

# æ‰¹é‡åˆ é™¤è®¢å•
DELETE /api/orders/batch
Body: { "orderIds": [1, 2, 3] }
Response: ApiResponse<bool>
```

#### 4. è¿è´¹ç®¡ç†

```http
# è®¡ç®—è¿è´¹
POST /api/shipping/calculate
Body: { "province": "å¹¿ä¸œçœ", "weight": 20.0 }
Response: ApiResponse<ShippingCalculationDto>

# è·å–è¿è´¹é…ç½®
GET /api/shipping/rates
Response: ApiResponse<List<ShippingRateDto>>

# æ›´æ–°è¿è´¹é…ç½®
PUT /api/shipping/rates/{province}
Body: { "rate": 1.8 }
Response: ApiResponse<ShippingRateDto>
```

---

## é¡¹ç›®ç»“æ„

```
LLXRice.Api/
â”œâ”€â”€ LLXRice.Api.sln                   # è§£å†³æ–¹æ¡ˆæ–‡ä»¶
â”œâ”€â”€ .cursorrules                       # Cursor å¼€å‘è§„åˆ™
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ ci-cd.yml                  # CI/CD é…ç½®
â”œâ”€â”€ src/
â”‚   â””â”€â”€ LLXRice.Api/                  # ä¸»é¡¹ç›®
â”‚       â”œâ”€â”€ Program.cs                 # åº”ç”¨å…¥å£ï¼ˆMinimal APIï¼‰
â”‚       â”œâ”€â”€ appsettings.json
â”‚       â”œâ”€â”€ appsettings.Development.json
â”‚       â”œâ”€â”€ appsettings.Production.json
â”‚       â”œâ”€â”€ LLXRice.Api.csproj
â”‚       â”œâ”€â”€ Models/
â”‚       â”‚   â”œâ”€â”€ Entities/              # å®ä½“æ¨¡å‹
â”‚       â”‚   â”‚   â”œâ”€â”€ Product.cs
â”‚       â”‚   â”‚   â”œâ”€â”€ Address.cs
â”‚       â”‚   â”‚   â”œâ”€â”€ Order.cs
â”‚       â”‚   â”‚   â”œâ”€â”€ OrderItem.cs
â”‚       â”‚   â”‚   â””â”€â”€ ShippingRate.cs
â”‚       â”‚   â””â”€â”€ DTOs/                  # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚       â”‚       â”œâ”€â”€ ProductDtos.cs
â”‚       â”‚       â”œâ”€â”€ AddressDtos.cs
â”‚       â”‚       â”œâ”€â”€ OrderDtos.cs
â”‚       â”‚       â”œâ”€â”€ ShippingDtos.cs
â”‚       â”‚       â””â”€â”€ ApiResponse.cs
â”‚       â”œâ”€â”€ Data/
â”‚       â”‚   â”œâ”€â”€ AppDbContext.cs        # EF Core ä¸Šä¸‹æ–‡
â”‚       â”‚   â””â”€â”€ Migrations/            # æ•°æ®åº“è¿ç§»
â”‚       â”œâ”€â”€ Services/
â”‚       â”‚   â”œâ”€â”€ IProductService.cs
â”‚       â”‚   â”œâ”€â”€ ProductService.cs
â”‚       â”‚   â”œâ”€â”€ IAddressService.cs
â”‚       â”‚   â”œâ”€â”€ AddressService.cs
â”‚       â”‚   â”œâ”€â”€ IOrderService.cs
â”‚       â”‚   â”œâ”€â”€ OrderService.cs
â”‚       â”‚   â”œâ”€â”€ IShippingService.cs
â”‚       â”‚   â”œâ”€â”€ ShippingService.cs
â”‚       â”‚   â””â”€â”€ ICacheService.cs
â”‚       â”‚       â””â”€â”€ RedisCacheService.cs
â”‚       â”œâ”€â”€ Repositories/
â”‚       â”‚   â”œâ”€â”€ IRepository.cs         # é€šç”¨ä»“å‚¨æ¥å£
â”‚       â”‚   â”œâ”€â”€ Repository.cs          # é€šç”¨ä»“å‚¨å®ç°
â”‚       â”‚   â”œâ”€â”€ IProductRepository.cs
â”‚       â”‚   â”œâ”€â”€ ProductRepository.cs
â”‚       â”‚   â”œâ”€â”€ IAddressRepository.cs
â”‚       â”‚   â”œâ”€â”€ AddressRepository.cs
â”‚       â”‚   â”œâ”€â”€ IOrderRepository.cs
â”‚       â”‚   â””â”€â”€ OrderRepository.cs
â”‚       â”œâ”€â”€ Endpoints/                 # Minimal API ç«¯ç‚¹
â”‚       â”‚   â”œâ”€â”€ ProductEndpoints.cs
â”‚       â”‚   â”œâ”€â”€ AddressEndpoints.cs
â”‚       â”‚   â”œâ”€â”€ OrderEndpoints.cs
â”‚       â”‚   â””â”€â”€ ShippingEndpoints.cs
â”‚       â”œâ”€â”€ Utils/
â”‚       â”‚   â”œâ”€â”€ AddressParser.cs       # åœ°å€è§£æå·¥å…·
â”‚       â”‚   â””â”€â”€ OrderNumberGenerator.cs
â”‚       â”œâ”€â”€ Middleware/
â”‚       â”‚   â”œâ”€â”€ ExceptionMiddleware.cs # å…¨å±€å¼‚å¸¸å¤„ç†
â”‚       â”‚   â””â”€â”€ LoggingMiddleware.cs   # è¯·æ±‚æ—¥å¿—
â”‚       â””â”€â”€ Extensions/
â”‚           â”œâ”€â”€ ServiceCollectionExtensions.cs
â”‚           â””â”€â”€ EndpointRouteBuilderExtensions.cs
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ init-db.sql                    # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ deploy-docker.sh               # Docker éƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ deploy-service.sh              # Systemd æœåŠ¡éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ API.md                         # API æ–‡æ¡£
â”‚   â”œâ”€â”€ DEPLOYMENT.md                  # éƒ¨ç½²æ–‡æ¡£
â”‚   â””â”€â”€ DEVELOPMENT.md                 # å¼€å‘æŒ‡å—
â””â”€â”€ README.md
```

---

## æ ¸å¿ƒä»£ç å®ç°

### 1. Program.csï¼ˆMinimal API å…¥å£ï¼‰

```csharp
using LLXRice.Api.Data;
using LLXRice.Api.Extensions;
using LLXRice.Api.Middleware;
using Microsoft.EntityFrameworkCore;
using Serilog;
using StackExchange.Redis;

var builder = WebApplication.CreateBuilder(args);

// ========== é…ç½® Serilog ==========
Log.Logger = new LoggerConfiguration()
    .ReadFrom.Configuration(builder.Configuration)
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .WriteTo.File("logs/log-.txt", rollingInterval: RollingInterval.Day)
    .CreateLogger();

builder.Host.UseSerilog();

// ========== é…ç½®æœåŠ¡ ==========

// æ·»åŠ  CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyMethod()
              .AllowAnyHeader();
    });
});

// é…ç½® PostgreSQL
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseNpgsql(builder.Configuration.GetConnectionString("DefaultConnection")));

// é…ç½® Redis
var redisConnection = builder.Configuration.GetConnectionString("Redis");
builder.Services.AddSingleton<IConnectionMultiplexer>(
    ConnectionMultiplexer.Connect(redisConnection));

// æ³¨å†ŒæœåŠ¡å’Œä»“å‚¨
builder.Services.RegisterServices();
builder.Services.RegisterRepositories();

// æ·»åŠ  Swagger
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new()
    {
        Title = "æ—é¾é¦™å¤§ç±³å•†åŸ API",
        Version = "v1",
        Description = "åŸºäº .NET 8 Minimal API çš„åç«¯æœåŠ¡"
    });
});

// æ·»åŠ å¥åº·æ£€æŸ¥
builder.Services.AddHealthChecks()
    .AddNpgSql(builder.Configuration.GetConnectionString("DefaultConnection"))
    .AddRedis(redisConnection);

var app = builder.Build();

// ========== é…ç½®ä¸­é—´ä»¶ç®¡é“ ==========

// Swaggerï¼ˆå¼€å‘å’Œç”Ÿäº§éƒ½å¯ç”¨ï¼Œæ–¹ä¾¿æµ‹è¯•ï¼‰
app.UseSwagger();
app.UseSwaggerUI(c =>
{
    c.SwaggerEndpoint("/swagger/v1/swagger.json", "LLXRice API v1");
    c.RoutePrefix = string.Empty; // Swagger UI ä½œä¸ºæ ¹è·¯å¾„
});

// å…¨å±€å¼‚å¸¸å¤„ç†
app.UseMiddleware<ExceptionMiddleware>();

// è¯·æ±‚æ—¥å¿—
app.UseMiddleware<LoggingMiddleware>();

// CORS
app.UseCors("AllowAll");

// HTTPS é‡å®šå‘ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
if (!app.Environment.IsDevelopment())
{
    app.UseHttpsRedirection();
}

// å¥åº·æ£€æŸ¥
app.MapHealthChecks("/health");

// ========== æ³¨å†Œ API ç«¯ç‚¹ ==========
app.MapProductEndpoints();
app.MapAddressEndpoints();
app.MapOrderEndpoints();
app.MapShippingEndpoints();

// ========== æ•°æ®åº“è¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®æ‰‹åŠ¨æ‰§è¡Œï¼‰ ==========
if (app.Environment.IsDevelopment())
{
    using (var scope = app.Services.CreateScope())
    {
        var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        await dbContext.Database.MigrateAsync();
        Log.Information("æ•°æ®åº“è¿ç§»å®Œæˆ");
    }
}

// ========== å¯åŠ¨åº”ç”¨ ==========
Log.Information("åº”ç”¨å¯åŠ¨ä¸­...");
app.Run();
Log.Information("åº”ç”¨å·²å…³é—­");
```

### 2. ApiResponseï¼ˆç»Ÿä¸€å“åº”æ¨¡å‹ï¼‰

```csharp
namespace LLXRice.Api.Models.DTOs;

public class ApiResponse<T>
{
    public bool Success { get; set; } = true;
    public string Message { get; set; } = "æ“ä½œæˆåŠŸ";
    public T? Data { get; set; }
    public List<string>? Errors { get; set; }
    public DateTime Timestamp { get; set; } = DateTime.UtcNow;

    public static ApiResponse<T> SuccessResponse(T data, string message = "æ“ä½œæˆåŠŸ")
    {
        return new ApiResponse<T>
        {
            Success = true,
            Message = message,
            Data = data
        };
    }

    public static ApiResponse<T> ErrorResponse(string message, List<string>? errors = null)
    {
        return new ApiResponse<T>
        {
            Success = false,
            Message = message,
            Errors = errors
        };
    }
}
```

### 3. ProductEndpointsï¼ˆå•†å“ç«¯ç‚¹ï¼‰

```csharp
using LLXRice.Api.Models.DTOs;
using LLXRice.Api.Services;
using Microsoft.AspNetCore.Mvc;

namespace LLXRice.Api.Endpoints;

public static class ProductEndpoints
{
    public static void MapProductEndpoints(this IEndpointRouteBuilder app)
    {
        var group = app.MapGroup("/api/products")
            .WithTags("Products")
            .WithOpenApi();

        // GET /api/products
        group.MapGet("/", async (IProductService service) =>
        {
            var products = await service.GetAllAsync();
            return Results.Ok(ApiResponse<List<ProductDto>>.SuccessResponse(products));
        })
        .WithName("GetProducts")
        .Produces<ApiResponse<List<ProductDto>>>();

        // GET /api/products/{id}
        group.MapGet("/{id}", async (int id, IProductService service) =>
        {
            var product = await service.GetByIdAsync(id);
            if (product == null)
                return Results.NotFound(ApiResponse<ProductDto>.ErrorResponse("å•†å“ä¸å­˜åœ¨"));

            return Results.Ok(ApiResponse<ProductDto>.SuccessResponse(product));
        })
        .WithName("GetProduct")
        .Produces<ApiResponse<ProductDto>>()
        .Produces(404);

        // POST /api/products
        group.MapPost("/", async ([FromBody] CreateProductDto dto, IProductService service) =>
        {
            var product = await service.CreateAsync(dto);
            return Results.Created($"/api/products/{product.Id}",
                ApiResponse<ProductDto>.SuccessResponse(product, "åˆ›å»ºæˆåŠŸ"));
        })
        .WithName("CreateProduct")
        .Produces<ApiResponse<ProductDto>>(201);

        // PUT /api/products/{id}
        group.MapPut("/{id}", async (int id, [FromBody] UpdateProductDto dto, IProductService service) =>
        {
            var product = await service.UpdateAsync(id, dto);
            if (product == null)
                return Results.NotFound(ApiResponse<ProductDto>.ErrorResponse("å•†å“ä¸å­˜åœ¨"));

            return Results.Ok(ApiResponse<ProductDto>.SuccessResponse(product, "æ›´æ–°æˆåŠŸ"));
        })
        .WithName("UpdateProduct")
        .Produces<ApiResponse<ProductDto>>()
        .Produces(404);

        // DELETE /api/products/{id}
        group.MapDelete("/{id}", async (int id, IProductService service) =>
        {
            var success = await service.DeleteAsync(id);
            if (!success)
                return Results.NotFound(ApiResponse<bool>.ErrorResponse("å•†å“ä¸å­˜åœ¨"));

            return Results.Ok(ApiResponse<bool>.SuccessResponse(true, "åˆ é™¤æˆåŠŸ"));
        })
        .WithName("DeleteProduct")
        .Produces<ApiResponse<bool>>()
        .Produces(404);
    }
}
```

### 4. AddressParserï¼ˆåœ°å€æ™ºèƒ½è¯†åˆ«ï¼‰

```csharp
using System.Text.RegularExpressions;

namespace LLXRice.Api.Utils;

public class AddressParser
{
    // çœä»½åˆ—è¡¨
    private static readonly string[] Provinces = new[]
    {
        "åŒ—äº¬å¸‚", "å¤©æ´¥å¸‚", "ä¸Šæµ·å¸‚", "é‡åº†å¸‚",
        "æ²³åŒ—çœ", "å±±è¥¿çœ", "è¾½å®çœ", "å‰æ—çœ", "é»‘é¾™æ±Ÿçœ",
        "æ±Ÿè‹çœ", "æµ™æ±Ÿçœ", "å®‰å¾½çœ", "ç¦å»ºçœ", "æ±Ÿè¥¿çœ", "å±±ä¸œçœ",
        "æ²³å—çœ", "æ¹–åŒ—çœ", "æ¹–å—çœ", "å¹¿ä¸œçœ", "æµ·å—çœ",
        "å››å·çœ", "è´µå·çœ", "äº‘å—çœ", "é™•è¥¿çœ", "ç”˜è‚ƒçœ", "é’æµ·çœ",
        "å†…è’™å¤è‡ªæ²»åŒº", "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº", "è¥¿è—è‡ªæ²»åŒº", "å®å¤å›æ—è‡ªæ²»åŒº", "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº",
        "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº", "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº", "å°æ¹¾çœ"
    };

    public static ParsedAddress Parse(string text)
    {
        if (string.IsNullOrWhiteSpace(text))
            throw new ArgumentException("åœ°å€æ–‡æœ¬ä¸èƒ½ä¸ºç©º");

        var result = new ParsedAddress();
        
        // æ¸…ç†æ–‡æœ¬ï¼šå»é™¤å¤šä½™ç©ºæ ¼ã€æ¢è¡Œç­‰
        var cleanText = Regex.Replace(text, @"\s+", " ").Trim();
        
        // 1. æå–å§“åï¼ˆ2-4ä¸ªæ±‰å­—ï¼Œåœ¨å¼€å¤´æˆ–"æ”¶è´§äºº"ä¹‹åï¼‰
        var nameMatch = Regex.Match(cleanText, @"(?:æ”¶è´§äºº[:ï¼š\s]*)?(?<name>[\u4e00-\u9fa5]{2,4})(?:å…ˆç”Ÿ|å¥³å£«)?");
        if (nameMatch.Success)
        {
            result.Name = nameMatch.Groups["name"].Value;
            cleanText = cleanText.Replace(nameMatch.Value, "");
        }

        // 2. æå–ç”µè¯ï¼ˆ11ä½æ‰‹æœºå·æˆ–å¸¦åŒºå·çš„å›ºå®šç”µè¯ï¼‰
        var phoneMatch = Regex.Match(cleanText, @"(?:ç”µè¯|æ‰‹æœº|è”ç³»æ–¹å¼)?[:ï¼š\s]*(?<phone>1[3-9]\d{9}|\d{3,4}-?\d{7,8})");
        if (phoneMatch.Success)
        {
            result.Phone = phoneMatch.Groups["phone"].Value.Replace("-", "");
            cleanText = cleanText.Replace(phoneMatch.Value, "");
        }

        // 3. æå–çœä»½
        foreach (var province in Provinces)
        {
            if (cleanText.Contains(province))
            {
                result.Province = province;
                cleanText = cleanText.Replace(province, "");
                break;
            }
            // å°è¯•å»æ‰"çœ"ã€"å¸‚"åŒ¹é…
            var shortProvince = province.Replace("çœ", "").Replace("å¸‚", "").Replace("è‡ªæ²»åŒº", "").Replace("ç‰¹åˆ«è¡Œæ”¿åŒº", "");
            if (cleanText.Contains(shortProvince))
            {
                result.Province = province;
                cleanText = cleanText.Replace(shortProvince, "");
                break;
            }
        }

        // 4. æå–åŸå¸‚
        var cityMatch = Regex.Match(cleanText, @"(?<city>[\u4e00-\u9fa5]{2,10}?(?:å¸‚|åœ°åŒº|å·|ç›Ÿ))");
        if (cityMatch.Success)
        {
            result.City = cityMatch.Value;
            cleanText = cleanText.Replace(cityMatch.Value, "");
        }

        // 5. æå–åŒºå¿
        var districtMatch = Regex.Match(cleanText, @"(?<district>[\u4e00-\u9fa5]{2,10}?(?:åŒº|å¿|å¸‚|æ——))");
        if (districtMatch.Success)
        {
            result.District = districtMatch.Value;
            cleanText = cleanText.Replace(districtMatch.Value, "");
        }

        // 6. å‰©ä½™éƒ¨åˆ†ä½œä¸ºè¯¦ç»†åœ°å€
        result.Detail = cleanText.Trim()
            .Replace("åœ°å€", "")
            .Replace(":", "")
            .Replace("ï¼š", "")
            .Trim();

        return result;
    }
}

public class ParsedAddress
{
    public string Name { get; set; } = string.Empty;
    public string Phone { get; set; } = string.Empty;
    public string Province { get; set; } = string.Empty;
    public string City { get; set; } = string.Empty;
    public string District { get; set; } = string.Empty;
    public string Detail { get; set; } = string.Empty;
}
```

---

## Redisç¼“å­˜ç­–ç•¥

### ç¼“å­˜è®¾è®¡åŸåˆ™

1. **çƒ­ç‚¹æ•°æ®ç¼“å­˜**: å•†å“åˆ—è¡¨ã€è¿è´¹é…ç½®ç­‰é«˜é¢‘è¯»å–æ•°æ®
2. **ç¼“å­˜å¤±æ•ˆç­–ç•¥**: æ›´æ–°æ•°æ®æ—¶ä¸»åŠ¨å¤±æ•ˆç¼“å­˜
3. **ç¼“å­˜ç©¿é€ä¿æŠ¤**: ç©ºå€¼ç¼“å­˜ï¼Œé˜²æ­¢æ¶æ„æŸ¥è¯¢
4. **ç¼“å­˜é›ªå´©ä¿æŠ¤**: éšæœºè¿‡æœŸæ—¶é—´ï¼Œé¿å…é›†ä¸­å¤±æ•ˆ

### ç¼“å­˜é”®å‘½åè§„èŒƒ

```
llxrice:products:all              # æ‰€æœ‰å•†å“åˆ—è¡¨
llxrice:products:{id}             # å•ä¸ªå•†å“
llxrice:shipping:rates            # è¿è´¹é…ç½®
llxrice:orders:{id}               # è®¢å•è¯¦æƒ…
```

### RedisCacheService å®ç°

```csharp
using StackExchange.Redis;
using System.Text.Json;

namespace LLXRice.Api.Services;

public interface ICacheService
{
    Task<T?> GetAsync<T>(string key);
    Task SetAsync<T>(string key, T value, TimeSpan? expiry = null);
    Task RemoveAsync(string key);
    Task RemoveByPatternAsync(string pattern);
}

public class RedisCacheService : ICacheService
{
    private readonly IDatabase _db;
    private readonly IServer _server;

    public RedisCacheService(IConnectionMultiplexer redis)
    {
        _db = redis.GetDatabase();
        _server = redis.GetServer(redis.GetEndPoints().First());
    }

    public async Task<T?> GetAsync<T>(string key)
    {
        var value = await _db.StringGetAsync(key);
        if (value.IsNullOrEmpty)
            return default;

        return JsonSerializer.Deserialize<T>(value!);
    }

    public async Task SetAsync<T>(string key, T value, TimeSpan? expiry = null)
    {
        var json = JsonSerializer.Serialize(value);
        await _db.StringSetAsync(key, json, expiry ?? TimeSpan.FromHours(1));
    }

    public async Task RemoveAsync(string key)
    {
        await _db.KeyDeleteAsync(key);
    }

    public async Task RemoveByPatternAsync(string pattern)
    {
        var keys = _server.Keys(pattern: pattern).ToArray();
        if (keys.Any())
            await _db.KeyDeleteAsync(keys);
    }
}
```

### ä½¿ç”¨ç¤ºä¾‹ï¼ˆProductServiceï¼‰

```csharp
public class ProductService : IProductService
{
    private readonly IProductRepository _repository;
    private readonly ICacheService _cache;
    private const string CacheKeyAll = "llxrice:products:all";
    private const string CacheKeyPrefix = "llxrice:products:";

    public async Task<List<ProductDto>> GetAllAsync()
    {
        // å°è¯•ä»ç¼“å­˜è·å–
        var cached = await _cache.GetAsync<List<ProductDto>>(CacheKeyAll);
        if (cached != null)
            return cached;

        // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“è·å–
        var products = await _repository.GetAllAsync();
        var dtos = products.Select(MapToDto).ToList();

        // å†™å…¥ç¼“å­˜ï¼Œéšæœºè¿‡æœŸæ—¶é—´ï¼ˆ50-70åˆ†é’Ÿï¼‰
        var expiry = TimeSpan.FromMinutes(50 + new Random().Next(20));
        await _cache.SetAsync(CacheKeyAll, dtos, expiry);

        return dtos;
    }

    public async Task<ProductDto> CreateAsync(CreateProductDto dto)
    {
        var product = await _repository.AddAsync(MapToEntity(dto));
        
        // æ¸…é™¤ç¼“å­˜
        await _cache.RemoveAsync(CacheKeyAll);
        
        return MapToDto(product);
    }
}
```

---

## éƒ¨ç½²æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šDocker Compose éƒ¨ç½²ï¼ˆæ¨èï¼‰

#### 1. Dockerfile

```dockerfile
# Dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 8080
EXPOSE 8081

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["src/LLXRice.Api/LLXRice.Api.csproj", "LLXRice.Api/"]
RUN dotnet restore "LLXRice.Api/LLXRice.Api.csproj"
COPY src/ .
WORKDIR "/src/LLXRice.Api"
RUN dotnet build "LLXRice.Api.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "LLXRice.Api.csproj" -c Release -o /app/publish /p:UseAppHost=false

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /app/logs

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV ASPNETCORE_URLS=http://+:8080
ENV ASPNETCORE_ENVIRONMENT=Production

ENTRYPOINT ["dotnet", "LLXRice.Api.dll"]
```

#### 2. docker-compose.yml

```yaml
version: '3.8'

services:
  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:16-alpine
    container_name: llxrice_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: llxrice
      POSTGRES_USER: llxrice_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-your_strong_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - llxrice_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U llxrice_user -d llxrice"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis ç¼“å­˜
  redis:
    image: redis:7.2-alpine
    container_name: llxrice_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-your_redis_password}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - llxrice_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # .NET API æœåŠ¡
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: llxrice_api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=llxrice;Username=llxrice_user;Password=${DB_PASSWORD:-your_strong_password}
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD:-your_redis_password}
    expose:
      - "8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - llxrice_network
    volumes:
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:alpine
    container_name: llxrice_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
      - ./static:/usr/share/nginx/html:ro
    depends_on:
      - api
    networks:
      - llxrice_network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  llxrice_network:
    driver: bridge
```

#### 3. .env æ–‡ä»¶

```bash
# .env
DB_PASSWORD=your_strong_db_password_here
REDIS_PASSWORD=your_strong_redis_password_here
```

#### 4. Nginx é…ç½®æ–‡ä»¶

**nginx/nginx.conf** (ä¸»é…ç½®æ–‡ä»¶)

```nginx
user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
    use epoll;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      'rt=$request_time uct="$upstream_connect_time" '
                      'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log  /var/log/nginx/access.log  main;

    # æ€§èƒ½ä¼˜åŒ–
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    # Gzip å‹ç¼©
    gzip  on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";

    # é™æµé…ç½®
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/s;
    
    # è¿æ¥é™åˆ¶
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # åŒ…å«ç«™ç‚¹é…ç½®
    include /etc/nginx/conf.d/*.conf;
}
```

**nginx/conf.d/llxrice.conf** (ç«™ç‚¹é…ç½®)

```nginx
# API ä¸Šæ¸¸æœåŠ¡å™¨
upstream llxrice_api {
    # è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šleast_conn (æœ€å°‘è¿æ¥)
    least_conn;
    
    # åç«¯ API æœåŠ¡å™¨åˆ—è¡¨
    server api:8080 max_fails=3 fail_timeout=30s;
    # å¦‚æœ‰å¤šä¸ªå®ä¾‹ï¼Œæ·»åŠ æ›´å¤šæœåŠ¡å™¨
    # server api2:8080 max_fails=3 fail_timeout=30s;
    # server api3:8080 max_fails=3 fail_timeout=30s;
    
    # ä¿æŒè¿æ¥
    keepalive 32;
}

# HTTP æœåŠ¡å™¨ (é‡å®šå‘åˆ° HTTPS)
server {
    listen 80;
    server_name api.llxrice.com;  # æ›¿æ¢ä¸ºå®é™…åŸŸå
    
    # Let's Encrypt è¯ä¹¦éªŒè¯
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # é‡å®šå‘åˆ° HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS æœåŠ¡å™¨
server {
    listen 443 ssl http2;
    server_name api.llxrice.com;  # æ›¿æ¢ä¸ºå®é™…åŸŸå
    
    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # HSTS (å¯é€‰ï¼Œç”Ÿäº§ç¯å¢ƒæ¨è)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/llxrice_access.log main;
    error_log /var/log/nginx/llxrice_error.log warn;
    
    # è¿æ¥é™åˆ¶ï¼šæ¯ä¸ª IP æœ€å¤š 20 ä¸ªè¿æ¥
    limit_conn conn_limit 20;
    
    # API è¯·æ±‚
    location /api/ {
        # è¯·æ±‚é™æµï¼šæ¯ç§’ 100 ä¸ªè¯·æ±‚ï¼Œçªå‘ 200
        limit_req zone=api_limit burst=200 nodelay;
        
        # ä»£ç†åˆ°åç«¯ API
        proxy_pass http://llxrice_api/;
        
        # ä»£ç†å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # WebSocket æ”¯æŒ (å¦‚éœ€è¦)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹ (ä¸é™æµ)
    location /health {
        proxy_pass http://llxrice_api/health;
        access_log off;
    }
    
    # Swagger æ–‡æ¡£ (å¼€å‘/æµ‹è¯•ç¯å¢ƒ)
    location /swagger {
        proxy_pass http://llxrice_api/swagger;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # é™æ€èµ„æº
    location /static/ {
        alias /usr/share/nginx/html/;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
    
    # é”™è¯¯é¡µé¢
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```

**nginx/conf.d/http_upgrade.conf** (HTTP åˆ° HTTPS å‡çº§ï¼Œå¯é€‰)

```nginx
# å¯¹æ‰€æœ‰ HTTP è¯·æ±‚è¿”å› 301 é‡å®šå‘åˆ° HTTPS
server {
    listen 80 default_server;
    server_name _;
    return 301 https://$host$request_uri;
}
```

#### 5. SSL è¯ä¹¦é…ç½®

**ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦**

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d api.llxrice.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

**ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼ˆå¼€å‘ç¯å¢ƒï¼‰**

```bash
# åˆ›å»º SSL ç›®å½•
mkdir -p nginx/ssl

# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx/ssl/privkey.pem \
  -out nginx/ssl/fullchain.pem \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=LLXRice/CN=api.llxrice.com"
```

#### 6. ç›®å½•ç»“æ„

```
project/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ .env
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ nginx.conf           # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ conf.d/
â”‚   â”‚   â”œâ”€â”€ llxrice.conf     # ç«™ç‚¹é…ç½®
â”‚   â”‚   â””â”€â”€ http_upgrade.conf  # HTTPå‡çº§é…ç½®
â”‚   â”œâ”€â”€ ssl/
â”‚   â”‚   â”œâ”€â”€ fullchain.pem    # SSL è¯ä¹¦
â”‚   â”‚   â””â”€â”€ privkey.pem      # ç§é’¥
â”‚   â””â”€â”€ logs/                # Nginx æ—¥å¿—
â”œâ”€â”€ static/                  # é™æ€èµ„æº
â””â”€â”€ logs/                    # API æ—¥å¿—
```

#### 7. éƒ¨ç½²å‘½ä»¤

```bash
# 1. å…‹éš†ä»£ç 
git clone <repository-url>
cd LLXRice.Api

# 2. åˆ›å»ºå¿…è¦çš„ç›®å½•
mkdir -p nginx/conf.d nginx/ssl nginx/logs static logs

# 3. åˆ›å»º nginx é…ç½®æ–‡ä»¶
# å¤åˆ¶ä¸Šé¢æä¾›çš„é…ç½®æ–‡ä»¶å†…å®¹åˆ°ç›¸åº”ä½ç½®
cat > nginx/nginx.conf << 'EOF'
# ç²˜è´´ nginx.conf å†…å®¹
EOF

cat > nginx/conf.d/llxrice.conf << 'EOF'
# ç²˜è´´ llxrice.conf å†…å®¹
EOF

# 4. ç”Ÿæˆ SSL è¯ä¹¦ï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨è‡ªç­¾åï¼‰
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx/ssl/privkey.pem \
  -out nginx/ssl/fullchain.pem \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=LLXRice/CN=api.llxrice.com"

# 5. åˆ›å»º .env æ–‡ä»¶å¹¶è®¾ç½®å¯†ç 
cat > .env << EOF
DB_PASSWORD=your_strong_password
REDIS_PASSWORD=your_redis_password
EOF

# 6. å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬ Nginxï¼‰
docker-compose up -d

# 7. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 8. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f nginx    # Nginx æ—¥å¿—
docker-compose logs -f api      # API æ—¥å¿—

# 9. æµ‹è¯•æœåŠ¡
curl http://localhost/health    # é€šè¿‡ Nginx è®¿é—®
curl http://localhost:8080/health  # ç›´æ¥è®¿é—® API (ä»…ç”¨äºæµ‹è¯•)

# 10. æŸ¥çœ‹ Nginx é…ç½®æ˜¯å¦æ­£ç¡®
docker exec llxrice_nginx nginx -t

# 11. é‡æ–°åŠ è½½ Nginx é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰
docker exec llxrice_nginx nginx -s reload

# 12. æŸ¥çœ‹ Nginx è®¿é—®æ—¥å¿—
tail -f nginx/logs/llxrice_access.log

# 13. åœæ­¢æœåŠ¡
docker-compose down

# 14. åœæ­¢å¹¶åˆ é™¤æ•°æ®å·ï¼ˆå±é™©æ“ä½œï¼‰
docker-compose down -v
```

#### 8. Nginx æ€§èƒ½ä¼˜åŒ–å»ºè®®

**1. Worker è¿›ç¨‹æ•°ä¼˜åŒ–**
```nginx
# è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°
worker_processes auto;

# æ¯ä¸ª worker çš„æœ€å¤§è¿æ¥æ•°
events {
    worker_connections 4096;
}
```

**2. å¯ç”¨ç¼“å­˜**
```nginx
# åœ¨ http å—ä¸­æ·»åŠ 
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m inactive=60m;
proxy_cache_key "$scheme$request_method$host$request_uri";

# åœ¨ location å—ä¸­ä½¿ç”¨
location /api/ {
    proxy_cache api_cache;
    proxy_cache_valid 200 5m;
    proxy_cache_valid 404 1m;
    add_header X-Cache-Status $upstream_cache_status;
}
```

**3. è¿æ¥ä¿æŒä¼˜åŒ–**
```nginx
keepalive_timeout 65;
keepalive_requests 100;

upstream llxrice_api {
    keepalive 32;
    keepalive_timeout 60s;
}
```

#### 9. Nginx ç›‘æ§å’Œç»´æŠ¤

**æŸ¥çœ‹ Nginx çŠ¶æ€**
```bash
# æŸ¥çœ‹ Nginx è¿›ç¨‹
ps aux | grep nginx

# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep nginx

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f nginx/logs/llxrice_error.log
```

**æ—¥å¿—åˆ†æ**
```bash
# ç»Ÿè®¡è®¿é—®æœ€å¤šçš„ IP
awk '{print $1}' nginx/logs/llxrice_access.log | sort | uniq -c | sort -rn | head -10

# ç»Ÿè®¡è®¿é—®æœ€å¤šçš„ URL
awk '{print $7}' nginx/logs/llxrice_access.log | sort | uniq -c | sort -rn | head -10

# ç»Ÿè®¡å“åº”æ—¶é—´
awk '{print $NF}' nginx/logs/llxrice_access.log | sort -n | tail -100
```

**æ—¥å¿—è½®è½¬**
```bash
# åˆ›å»º logrotate é…ç½®
cat > /etc/logrotate.d/nginx << EOF
/path/to/nginx/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 nginx nginx
    sharedscripts
    postrotate
        docker exec llxrice_nginx nginx -s reload > /dev/null 2>&1
    endscript
}
EOF
```

### æ–¹æ¡ˆäºŒï¼šSystemd æœåŠ¡éƒ¨ç½²

#### 1. ç¯å¢ƒå‡†å¤‡

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… .NET 8 Runtime
wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
rm packages-microsoft-prod.deb
sudo apt update
sudo apt install -y aspnetcore-runtime-8.0

# å®‰è£… PostgreSQL 16
sudo apt install -y postgresql-16 postgresql-contrib-16

# å®‰è£… Redis
sudo apt install -y redis-server

# é…ç½® Redis å¯†ç 
sudo nano /etc/redis/redis.conf
# æ‰¾åˆ° # requirepass foobared
# ä¿®æ”¹ä¸º requirepass your_redis_password
sudo systemctl restart redis-server

# å®‰è£… Nginx
sudo apt install -y nginx

# å¯åŠ¨ Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 2. éƒ¨ç½²åº”ç”¨

```bash
# å‘å¸ƒåº”ç”¨
cd src/LLXRice.Api
dotnet publish -c Release -o /var/www/llxrice-api

# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/www/llxrice-api/logs
sudo chown -R www-data:www-data /var/www/llxrice-api

# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo nano /var/www/llxrice-api/appsettings.Production.json
```

**appsettings.Production.json**:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=llxrice;Username=llxrice_user;Password=your_db_password",
    "Redis": "localhost:6379,password=your_redis_password"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

#### 3. åˆ›å»º Systemd æœåŠ¡

```bash
sudo nano /etc/systemd/system/llxrice-api.service
```

**llxrice-api.service**:

```ini
[Unit]
Description=LLXRice API Service
After=network.target postgresql.service redis.service

[Service]
Type=notify
User=www-data
WorkingDirectory=/var/www/llxrice-api
ExecStart=/usr/bin/dotnet /var/www/llxrice-api/LLXRice.Api.dll
Restart=always
RestartSec=10
KillSignal=SIGINT
SyslogIdentifier=llxrice-api
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

[Install]
WantedBy=multi-user.target
```

#### 4. å¯åŠ¨æœåŠ¡

```bash
# é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start llxrice-api

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable llxrice-api

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status llxrice-api

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u llxrice-api -f
```

#### 5. é…ç½® Nginx åå‘ä»£ç†

**åˆ›å»º Nginx é…ç½®æ–‡ä»¶**:

```bash
sudo nano /etc/nginx/sites-available/llxrice-api
```

**å®Œæ•´çš„ Nginx é…ç½®**:

```nginx
# HTTP æœåŠ¡å™¨ (é‡å®šå‘åˆ° HTTPS)
server {
    listen 80;
    server_name api.llxrice.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸå
    
    # Let's Encrypt è¯ä¹¦éªŒè¯
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # é‡å®šå‘åˆ° HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS æœåŠ¡å™¨
server {
    listen 443 ssl http2;
    server_name api.llxrice.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸå
    
    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/api.llxrice.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.llxrice.com/privkey.pem;
    
    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # æ—¥å¿—
    access_log /var/log/nginx/llxrice_access.log;
    error_log /var/log/nginx/llxrice_error.log warn;
    
    # é™æµé…ç½®
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    
    # è¿æ¥é™åˆ¶
    limit_conn conn_limit 20;
    
    # API è¯·æ±‚
    location /api/ {
        # è¯·æ±‚é™æµ
        limit_req zone=api_limit burst=200 nodelay;
        
        # ä»£ç†åˆ°åç«¯
        proxy_pass http://localhost:8080/;
        proxy_http_version 1.1;
        
        # ä»£ç†å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹ (ä¸é™æµ)
    location /health {
        proxy_pass http://localhost:8080/health;
        access_log off;
    }
    
    # Swagger æ–‡æ¡£
    location /swagger {
        proxy_pass http://localhost:8080/swagger;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # é™æ€èµ„æº
    location /static/ {
        alias /var/www/llxrice-api/wwwroot/;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}
```

**å¯ç”¨ç«™ç‚¹å¹¶é…ç½® SSL**:

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/llxrice-api /etc/nginx/sites-enabled/

# æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t

# æš‚æ—¶é‡å¯ Nginx (ä½¿ç”¨ HTTP é…ç½®)
sudo systemctl restart nginx

# å®‰è£… Certbot å¹¶è·å– SSL è¯ä¹¦
sudo apt install -y certbot python3-certbot-nginx

# è·å– Let's Encrypt è¯ä¹¦
sudo certbot --nginx -d api.llxrice.com

# è‡ªåŠ¨ç»­æœŸè¯ä¹¦ï¼ˆè®¾ç½®å®šæ—¶ä»»åŠ¡ï¼‰
sudo certbot renew --dry-run

# æ·»åŠ è‡ªåŠ¨ç»­æœŸçš„ cron ä»»åŠ¡
(crontab -l 2>/dev/null; echo "0 0 1 * * /usr/bin/certbot renew --quiet") | crontab -

# é‡å¯ Nginx ä½¿ HTTPS é…ç½®ç”Ÿæ•ˆ
sudo systemctl restart nginx

# æŸ¥çœ‹ Nginx çŠ¶æ€
sudo systemctl status nginx
```

**Nginx ä¼˜åŒ–é…ç½®** (å¯é€‰):

ç¼–è¾‘ `/etc/nginx/nginx.conf`:

```nginx
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

http {
    # åŸºç¡€è®¾ç½®
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;
    
    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;
    
    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time';
    
    # åŒ…å«ç«™ç‚¹é…ç½®
    include /etc/nginx/mime.types;
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

### éƒ¨ç½²æ£€æŸ¥æ¸…å•

#### æ•°æ®åº“å’Œç¼“å­˜
- [ ] PostgreSQL æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] Redis æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] Redis è¿æ¥æ­£å¸¸
- [ ] æ•°æ®åº“å·²åˆå§‹åŒ–ï¼ˆè¡¨å’Œåˆå§‹æ•°æ®ï¼‰
- [ ] æ•°æ®åº“å¤‡ä»½ç­–ç•¥å·²è®¾ç½®

#### API æœåŠ¡
- [ ] .NET API æœåŠ¡å¯åŠ¨æ­£å¸¸
- [ ] Swagger æ–‡æ¡£å¯è®¿é—®
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸ (`/health`)
- [ ] API æ—¥å¿—æ–‡ä»¶æ­£å¸¸å†™å…¥
- [ ] CORS é…ç½®æ­£ç¡®

#### Nginx åå‘ä»£ç†
- [ ] Nginx æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] Nginx é…ç½®è¯­æ³•æ­£ç¡® (`nginx -t`)
- [ ] HTTP åˆ° HTTPS é‡å®šå‘æ­£å¸¸
- [ ] SSL è¯ä¹¦å·²é…ç½®ä¸”æœ‰æ•ˆ
- [ ] SSL è¯ä¹¦è‡ªåŠ¨ç»­æœŸå·²è®¾ç½®
- [ ] ä»£ç†åˆ°åç«¯ API æ­£å¸¸
- [ ] è¯·æ±‚é™æµé…ç½®ç”Ÿæ•ˆ
- [ ] Gzip å‹ç¼©æ­£å¸¸å·¥ä½œ
- [ ] Nginx è®¿é—®æ—¥å¿—æ­£å¸¸å†™å…¥
- [ ] é™æ€èµ„æºæœåŠ¡æ­£å¸¸

#### ç½‘ç»œå’Œå®‰å…¨
- [ ] é˜²ç«å¢™ç«¯å£å·²å¼€æ”¾ï¼ˆ80, 443ï¼‰
- [ ] å†…éƒ¨ç«¯å£å·²é™åˆ¶è®¿é—®ï¼ˆ8080, 5432, 6379ï¼‰
- [ ] å®‰å…¨å¤´é…ç½®æ­£ç¡®
- [ ] HTTPS å¼ºåˆ¶è·³è½¬æ­£å¸¸
- [ ] åŸŸå DNS è§£ææ­£ç¡®

#### ç›‘æ§å’Œè¿ç»´
- [ ] æ—¥å¿—è½®è½¬é…ç½®æ­£ç¡®
- [ ] ç£ç›˜ç©ºé—´å……è¶³
- [ ] æœåŠ¡å¼€æœºè‡ªå¯å·²é…ç½®
- [ ] ç›‘æ§å‘Šè­¦å·²è®¾ç½®ï¼ˆå¯é€‰ï¼‰

#### åŠŸèƒ½æµ‹è¯•
- [ ] API æ¥å£è°ƒç”¨æ­£å¸¸
- [ ] æ•°æ®è¯»å†™æ­£å¸¸
- [ ] ç¼“å­˜å‘½ä¸­æ­£å¸¸
- [ ] å¹¶å‘æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡

---

## å¼€å‘è§„èŒƒ

### å‘½åè§„èŒƒ

1. **ç±»å**: PascalCaseï¼Œå¦‚ `ProductService`
2. **æ¥å£å**: I + PascalCaseï¼Œå¦‚ `IProductService`
3. **æ–¹æ³•å**: PascalCaseï¼Œå¦‚ `GetAllAsync`
4. **å‚æ•°/å˜é‡**: camelCaseï¼Œå¦‚ `productId`
5. **å¸¸é‡**: PascalCaseï¼Œå¦‚ `CacheKeyAll`
6. **ç§æœ‰å­—æ®µ**: _camelCaseï¼Œå¦‚ `_repository`

### å¼‚æ­¥ç¼–ç¨‹

- æ‰€æœ‰ I/O æ“ä½œå¿…é¡»ä½¿ç”¨å¼‚æ­¥æ–¹æ³•
- å¼‚æ­¥æ–¹æ³•åå¿…é¡»ä»¥ `Async` ç»“å°¾
- ä½¿ç”¨ `async/await`ï¼Œä¸è¦ä½¿ç”¨ `.Result` æˆ– `.Wait()`

```csharp
// âœ… æ­£ç¡®
public async Task<List<Product>> GetAllAsync()
{
    return await _repository.GetAllAsync();
}

// âŒ é”™è¯¯
public List<Product> GetAll()
{
    return _repository.GetAllAsync().Result;
}
```

### é”™è¯¯å¤„ç†

- ä½¿ç”¨å…¨å±€å¼‚å¸¸ä¸­é—´ä»¶å¤„ç†å¼‚å¸¸
- ä¸šåŠ¡å¼‚å¸¸æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

```csharp
public async Task<Product> GetByIdAsync(int id)
{
    var product = await _repository.GetByIdAsync(id);
    if (product == null)
        throw new NotFoundException($"å•†å“ {id} ä¸å­˜åœ¨");
    
    return product;
}
```

### æ—¥å¿—è®°å½•

- ä½¿ç”¨ Serilog ç»“æ„åŒ–æ—¥å¿—
- å…³é”®æ“ä½œè®°å½•æ—¥å¿—
- åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯

```csharp
_logger.LogInformation("åˆ›å»ºå•†å“: {ProductName}, ä»·æ ¼: {Price}", dto.Name, dto.Price);
_logger.LogError(ex, "è·å–å•†å“ {ProductId} å¤±è´¥", id);
```

---

## å°ç¨‹åºå¯¹æ¥è¯´æ˜

### 1. API åŸºç¡€é…ç½®

åœ¨å°ç¨‹åºä¸­é…ç½®æœåŠ¡å™¨åŸŸåï¼ˆå¾®ä¿¡å…¬ä¼—å¹³å° -> å¼€å‘ -> å¼€å‘è®¾ç½® -> æœåŠ¡å™¨åŸŸåï¼‰:

```
requeståˆæ³•åŸŸå: https://api.llxrice.com
```

### 2. HTTP å®¢æˆ·ç«¯å°è£…

åˆ›å»º `utils/httpClient.js`:

```javascript
const BASE_URL = 'https://api.llxrice.com/api'

class HttpClient {
  static async request(url, method = 'GET', data = null) {
    return new Promise((resolve, reject) => {
      wx.showLoading({ title: 'åŠ è½½ä¸­...', mask: true })
      
      wx.request({
        url: `${BASE_URL}${url}`,
        method,
        data,
        header: {
          'Content-Type': 'application/json'
        },
        success: (res) => {
          wx.hideLoading()
          if (res.statusCode === 200 && res.data.success) {
            resolve(res.data.data)
          } else {
            wx.showToast({
              title: res.data.message || 'è¯·æ±‚å¤±è´¥',
              icon: 'none'
            })
            reject(res.data)
          }
        },
        fail: (err) => {
          wx.hideLoading()
          wx.showToast({ title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥', icon: 'none' })
          reject(err)
        }
      })
    })
  }

  static get(url) {
    return this.request(url, 'GET')
  }

  static post(url, data) {
    return this.request(url, 'POST', data)
  }

  static put(url, data) {
    return this.request(url, 'PUT', data)
  }

  static delete(url) {
    return this.request(url, 'DELETE')
  }
}

module.exports = HttpClient
```

### 3. API æœåŠ¡å°è£…

åˆ›å»º `utils/apiService.js`:

```javascript
const HttpClient = require('./httpClient.js')

class ApiService {
  // ========== å•†å“ ==========
  static getProducts() {
    return HttpClient.get('/products')
  }

  static createProduct(data) {
    return HttpClient.post('/products', data)
  }

  static updateProduct(id, data) {
    return HttpClient.put(`/products/${id}`, data)
  }

  static deleteProduct(id) {
    return HttpClient.delete(`/products/${id}`)
  }

  // ========== åœ°å€ ==========
  static getAddresses() {
    return HttpClient.get('/addresses')
  }

  static createAddress(data) {
    return HttpClient.post('/addresses', data)
  }

  static parseAddress(text) {
    return HttpClient.post('/addresses/parse', { text })
  }

  // ========== è®¢å• ==========
  static getOrders(page = 1, pageSize = 10, status = null) {
    let url = `/orders?page=${page}&pageSize=${pageSize}`
    if (status) url += `&status=${status}`
    return HttpClient.get(url)
  }

  static createOrder(data) {
    return HttpClient.post('/orders', data)
  }

  // ========== è¿è´¹ ==========
  static calculateShipping(province, weight) {
    return HttpClient.post('/shipping/calculate', { province, weight })
  }
}

module.exports = ApiService
```

### 4. é¡µé¢æ”¹é€ ç¤ºä¾‹

```javascript
// pages/index/index.js
const ApiService = require('../../utils/apiService.js')

Page({
  data: {
    riceProducts: []
  },

  async onLoad() {
    await this.loadProducts()
  },

  async loadProducts() {
    try {
      const products = await ApiService.getProducts()
      this.setData({
        riceProducts: products,
        isEmpty: products.length === 0
      })
    } catch (error) {
      console.error('åŠ è½½å•†å“å¤±è´¥', error)
      // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
      this.loadLocalData()
    }
  }
})
```

---

## æ€»ç»“

æœ¬è®¾è®¡æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ .NET 8 Minimal API åç«¯æœåŠ¡æ¶æ„ï¼ŒåŒ…æ‹¬ï¼š

âœ… **æŠ€æœ¯é€‰å‹**: .NET 8 Minimal API + PostgreSQL + Redis  
âœ… **æ•°æ®åº“è®¾è®¡**: å®Œæ•´çš„è¡¨ç»“æ„å’Œç´¢å¼•è®¾è®¡  
âœ… **API è®¾è®¡**: RESTful API è§„èŒƒï¼Œç»Ÿä¸€å“åº”æ ¼å¼  
âœ… **ç¼“å­˜ç­–ç•¥**: Redis ç¼“å­˜ä¼˜åŒ–ï¼Œæå‡æ€§èƒ½  
âœ… **éƒ¨ç½²æ–¹æ¡ˆ**: Docker å’Œ Systemd ä¸¤ç§éƒ¨ç½²æ–¹å¼  
âœ… **ä»£ç è§„èŒƒ**: æ¸…æ™°çš„å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ  
âœ… **å°ç¨‹åºå¯¹æ¥**: è¯¦ç»†çš„å¯¹æ¥è¯´æ˜å’Œç¤ºä¾‹ä»£ç 

è¯¥æ–¹æ¡ˆå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **æ€§èƒ½ä¼˜å¼‚**: Minimal API + Redis ç¼“å­˜ï¼Œå“åº”é€Ÿåº¦å¿«
2. **æ˜“äºéƒ¨ç½²**: Docker Compose ä¸€é”®éƒ¨ç½²ï¼Œç¯å¢ƒä¸€è‡´æ€§å¥½
3. **æ˜“äºç»´æŠ¤**: åˆ†å±‚æ¶æ„æ¸…æ™°ï¼Œä»£ç èŒè´£æ˜ç¡®
4. **æ˜“äºæ‰©å±•**: é¢„ç•™é‰´æƒæ¥å£ï¼Œæ”¯æŒåç»­åŠŸèƒ½æ‰©å±•
5. **ç”Ÿäº§å°±ç»ª**: åŒ…å«æ—¥å¿—ã€å¥åº·æ£€æŸ¥ã€å¼‚å¸¸å¤„ç†ç­‰å®Œæ•´åŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´10æœˆ17æ—¥  
**é€‚ç”¨ç‰ˆæœ¬**: .NET 8 + PostgreSQL 16 + Redis 7.2  
**ç»´æŠ¤çŠ¶æ€**: âœ… å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

---

Â© 2025 æ—é¾é¦™å¤§ç±³å•†åŸåç«¯æœåŠ¡è®¾è®¡æ–¹æ¡ˆ
