# å®¹å™¨è¿è¡Œé—®é¢˜ä¿®å¤æŒ‡å—

## ğŸš¨ é—®é¢˜æè¿°

åœ¨Linuxå®¹å™¨ä¸­è¿è¡Œæ—¶å‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š

1. **æ—¥å¿—æ–‡ä»¶æƒé™é—®é¢˜**ï¼š`Access to the path '/app/logs/error-2025-10-22.log' is denied`
2. **æ•°æ®åº“è¿æ¥å¤±è´¥**ï¼š`Failed to connect to 127.0.0.1:5432`
3. **Redisè¿æ¥å¤±è´¥**ï¼š`UnableToConnect on localhost:6379`

## ğŸ” é—®é¢˜åˆ†æ

### 1. æ—¥å¿—æ–‡ä»¶æƒé™é—®é¢˜
- å®¹å™¨å†…ç”¨æˆ· `appuser` æ²¡æœ‰å†™å…¥ `/app/logs` ç›®å½•çš„æƒé™
- å®¿ä¸»æœºæŒ‚è½½çš„ `./logs` ç›®å½•æƒé™ä¸æ­£ç¡®

### 2. æ•°æ®åº“è¿æ¥é—®é¢˜
- å®¹å™¨å†… `localhost` æŒ‡å‘å®¹å™¨æœ¬èº«ï¼Œä¸æ˜¯å®¿ä¸»æœº
- éœ€è¦ä½¿ç”¨å®¿ä¸»æœºçš„IPåœ°å€æˆ–Dockerç½‘ç»œåœ°å€

### 3. Redisè¿æ¥é—®é¢˜
- åŒæ ·çš„é—®é¢˜ï¼Œéœ€è¦ä½¿ç”¨æ­£ç¡®çš„ç½‘ç»œåœ°å€

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¿®å¤æƒé™å’Œç½‘ç»œé…ç½®ï¼ˆæ¨èï¼‰

#### 1. ä¿®å¤Dockerfileæƒé™é—®é¢˜

```dockerfile
# åœ¨Dockerfileä¸­ä¿®å¤æƒé™è®¾ç½®
RUN mkdir -p /app/logs && \
    chown -R appuser:appuser /app && \
    chmod -R 755 /app/logs
```

#### 2. åˆ›å»ºæ­£ç¡®çš„ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶
cp env.api-only.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env
```

**å…³é”®é…ç½®ä¿®æ”¹**ï¼š

```bash
# æ•°æ®åº“è¿æ¥ - ä½¿ç”¨å®¿ä¸»æœºIPæˆ–Dockerç½‘ç»œ
DB_CONNECTION_STRING=Host=host.docker.internal;Port=5432;Database=llxrice;Username=llxrice_user;Password=your_password;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30

# Redisè¿æ¥ - ä½¿ç”¨å®¿ä¸»æœºIPæˆ–Dockerç½‘ç»œ
REDIS_CONNECTION_STRING=host.docker.internal:6379,password=your_redis_password,ssl=false,abortConnect=false
```

#### 3. ä¿®å¤å®¿ä¸»æœºæ—¥å¿—ç›®å½•æƒé™

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# è®¾ç½®æ­£ç¡®çš„æƒé™
chmod 755 logs

# ç¡®ä¿Dockerå¯ä»¥å†™å…¥
sudo chown -R $USER:$USER logs
```

#### 4. ä½¿ç”¨hostç½‘ç»œæ¨¡å¼ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

ä¿®æ”¹ `docker-compose.api-only.yml`ï¼š

```yaml
services:
  api:
    # ... å…¶ä»–é…ç½® ...
    network_mode: "host"  # ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ
    # æ³¨é‡Šæ‰portsé…ç½®ï¼Œå› ä¸ºä½¿ç”¨hostç½‘ç»œ
    # ports:
    #   - "8080:8080"
```

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨Dockerç½‘ç»œï¼ˆæ¨èç”¨äºç”Ÿäº§ï¼‰

#### 1. åˆ›å»ºDockerç½‘ç»œ

```bash
# åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ
docker network create llxrice_network

# æŸ¥çœ‹ç½‘ç»œ
docker network ls
```

#### 2. ä¿®æ”¹docker-composeé…ç½®

```yaml
version: "3.8"

services:
  api:
    # ... å…¶ä»–é…ç½® ...
    networks:
      - llxrice_network
    # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ç½‘ç»œåœ°å€
    environment:
      - ConnectionStrings__DefaultConnection=${DB_CONNECTION_STRING}
      - ConnectionStrings__Redis=${REDIS_CONNECTION_STRING}

networks:
  llxrice_network:
    driver: bridge
    external: true  # ä½¿ç”¨å¤–éƒ¨ç½‘ç»œ
```

#### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# åœ¨.envæ–‡ä»¶ä¸­é…ç½®æ­£ç¡®çš„ç½‘ç»œåœ°å€
DB_CONNECTION_STRING=Host=postgres_host;Port=5432;Database=llxrice;Username=llxrice_user;Password=your_password;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30
REDIS_CONNECTION_STRING=redis_host:6379,password=your_redis_password,ssl=false,abortConnect=false
```

## ğŸ› ï¸ å¿«é€Ÿä¿®å¤è„šæœ¬

### åˆ›å»ºä¿®å¤è„šæœ¬

```bash
#!/bin/bash
# fix-container-issues.sh

echo "ğŸ”§ ä¿®å¤å®¹å™¨è¿è¡Œé—®é¢˜..."

# 1. åˆ›å»ºæ—¥å¿—ç›®å½•å¹¶è®¾ç½®æƒé™
echo "åˆ›å»ºæ—¥å¿—ç›®å½•..."
mkdir -p logs
chmod 755 logs
sudo chown -R $USER:$USER logs

# 2. æ£€æŸ¥å¹¶åˆ›å»º.envæ–‡ä»¶
if [ ! -f ".env" ]; then
    echo "åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶..."
    cp env.api-only.example .env
    echo "âš ï¸  è¯·ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®æ­£ç¡®çš„æ•°æ®åº“å’ŒRedisè¿æ¥ä¿¡æ¯"
    echo "   æ•°æ®åº“è¿æ¥ç¤ºä¾‹: Host=host.docker.internal;Port=5432;..."
    echo "   Redisè¿æ¥ç¤ºä¾‹: host.docker.internal:6379,password=..."
    exit 1
fi

# 3. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
echo "æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®..."
if grep -q "localhost" .env; then
    echo "âš ï¸  å‘ç°localhosté…ç½®ï¼Œè¯·ä¿®æ”¹ä¸ºæ­£ç¡®çš„ç½‘ç»œåœ°å€"
    echo "   å»ºè®®ä½¿ç”¨: host.docker.internal æˆ–å…·ä½“çš„IPåœ°å€"
fi

# 4. é‡æ–°æ„å»ºé•œåƒ
echo "é‡æ–°æ„å»ºDockeré•œåƒ..."
docker build -f LLX.Server/Dockerfile -t llxrice/api:latest .

# 5. åœæ­¢ç°æœ‰å®¹å™¨
echo "åœæ­¢ç°æœ‰å®¹å™¨..."
docker stop llxrice_api 2>/dev/null || true
docker rm llxrice_api 2>/dev/null || true

# 6. å¯åŠ¨æœåŠ¡
echo "å¯åŠ¨æœåŠ¡..."
docker-compose -f docker-compose.api-only.yml up -d

echo "âœ… ä¿®å¤å®Œæˆï¼"
echo "è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€: docker logs llxrice_api"
```

### ä½¿ç”¨ä¿®å¤è„šæœ¬

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x fix-container-issues.sh

# æ‰§è¡Œä¿®å¤
./fix-container-issues.sh
```

## ğŸ” éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps --filter "name=llxrice_api"

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs llxrice_api

# è¿›å…¥å®¹å™¨æ£€æŸ¥æƒé™
docker exec -it llxrice_api ls -la /app/logs
```

### 2. æ£€æŸ¥ç½‘ç»œè¿æ¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
docker exec llxrice_api ping host.docker.internal

# æµ‹è¯•Redisè¿æ¥
docker exec llxrice_api telnet host.docker.internal 6379
```

### 3. æ£€æŸ¥å¥åº·çŠ¶æ€

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8080/health

# æŸ¥çœ‹è¯¦ç»†å¥åº·ä¿¡æ¯
curl http://localhost:8080/health | jq .
```

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### 1. æƒé™é—®é¢˜æŒç»­å­˜åœ¨

```bash
# æ£€æŸ¥å®¿ä¸»æœºç›®å½•æƒé™
ls -la logs/

# ä¿®å¤æƒé™
sudo chown -R 1000:1000 logs/
chmod -R 755 logs/
```

### 2. ç½‘ç»œè¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥Dockerç½‘ç»œ
docker network ls
docker network inspect bridge

# ä½¿ç”¨hostç½‘ç»œæ¨¡å¼ï¼ˆä¸´æ—¶ï¼‰
docker run --network host llxrice/api:latest
```

### 3. æ•°æ®åº“è¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦è¿è¡Œ
docker ps | grep postgres
netstat -tlnp | grep 5432

# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql -h localhost -p 5432 -U llxrice_user -d llxrice
```

### 4. Redisè¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
docker ps | grep redis
netstat -tlnp | grep 6379

# æµ‹è¯•Redisè¿æ¥
redis-cli -h localhost -p 6379 ping
```

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. ç½‘ç»œé…ç½®

- **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨ `host.docker.internal`
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨å…·ä½“çš„IPåœ°å€æˆ–æœåŠ¡å
- **Docker Compose**ï¼šä½¿ç”¨æœåŠ¡åä½œä¸ºä¸»æœºå

### 2. æƒé™ç®¡ç†

- ç¡®ä¿æ—¥å¿—ç›®å½•æƒé™æ­£ç¡®
- ä½¿ç”¨érootç”¨æˆ·è¿è¡Œå®¹å™¨
- æ­£ç¡®è®¾ç½®æ–‡ä»¶æ‰€æœ‰æƒ

### 3. ç¯å¢ƒå˜é‡

- ä½¿ç”¨ `.env` æ–‡ä»¶ç®¡ç†é…ç½®
- é¿å…ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- ä¸ºä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®

### 4. ç›‘æ§å’Œæ—¥å¿—

- å®šæœŸæ£€æŸ¥å®¹å™¨æ—¥å¿—
- ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
- è®¾ç½®å¥åº·æ£€æŸ¥

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. å®¹å™¨æ—¥å¿—ï¼š`docker logs llxrice_api`
2. ç¯å¢ƒé…ç½®ï¼š`cat .env`
3. ç³»ç»Ÿä¿¡æ¯ï¼š`docker version` å’Œ `docker-compose version`
4. ç½‘ç»œé…ç½®ï¼š`docker network ls`

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-22  
**é€‚ç”¨ç¯å¢ƒ**ï¼šLinux, Docker, Docker Compose
