# 容器运行问题修复指南

## 🚨 问题描述

在Linux容器中运行时出现以下问题：

1. **日志文件权限问题**：`Access to the path '/app/logs/error-2025-10-22.log' is denied`
2. **数据库连接失败**：`Failed to connect to 127.0.0.1:5432`
3. **Redis连接失败**：`UnableToConnect on localhost:6379`

## 🔍 问题分析

### 1. 日志文件权限问题
- 容器内用户 `appuser` 没有写入 `/app/logs` 目录的权限
- 宿主机挂载的 `./logs` 目录权限不正确

### 2. 数据库连接问题
- 容器内 `localhost` 指向容器本身，不是宿主机
- 需要使用宿主机的IP地址或Docker网络地址

### 3. Redis连接问题
- 同样的问题，需要使用正确的网络地址

## ✅ 解决方案

### 方案一：修复权限和网络配置（推荐）

#### 1. 修复Dockerfile权限问题

```dockerfile
# 在Dockerfile中修复权限设置
RUN mkdir -p /app/logs && \
    chown -R appuser:appuser /app && \
    chmod -R 755 /app/logs
```

#### 2. 创建正确的环境变量配置

创建 `.env` 文件：

```bash
# 复制示例文件
cp env.api-only.example .env

# 编辑配置文件
vim .env
```

**关键配置修改**：

```bash
# 数据库连接 - 使用宿主机IP或Docker网络
DB_CONNECTION_STRING=Host=host.docker.internal;Port=5432;Database=llxrice;Username=llxrice_user;Password=your_password;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30

# Redis连接 - 使用宿主机IP或Docker网络
REDIS_CONNECTION_STRING=host.docker.internal:6379,password=your_redis_password,ssl=false,abortConnect=false
```

#### 3. 修复宿主机日志目录权限

```bash
# 创建日志目录
mkdir -p logs

# 设置正确的权限
chmod 755 logs

# 确保Docker可以写入
sudo chown -R $USER:$USER logs
```

#### 4. 使用host网络模式（临时方案）

修改 `docker-compose.api-only.yml`：

```yaml
services:
  api:
    # ... 其他配置 ...
    network_mode: "host"  # 使用宿主机网络
    # 注释掉ports配置，因为使用host网络
    # ports:
    #   - "8080:8080"
```

### 方案二：使用Docker网络（推荐用于生产）

#### 1. 创建Docker网络

```bash
# 创建自定义网络
docker network create llxrice_network

# 查看网络
docker network ls
```

#### 2. 修改docker-compose配置

```yaml
version: "3.8"

services:
  api:
    # ... 其他配置 ...
    networks:
      - llxrice_network
    # 使用环境变量中的网络地址
    environment:
      - ConnectionStrings__DefaultConnection=${DB_CONNECTION_STRING}
      - ConnectionStrings__Redis=${REDIS_CONNECTION_STRING}

networks:
  llxrice_network:
    driver: bridge
    external: true  # 使用外部网络
```

#### 3. 配置环境变量

```bash
# 在.env文件中配置正确的网络地址
DB_CONNECTION_STRING=Host=postgres_host;Port=5432;Database=llxrice;Username=llxrice_user;Password=your_password;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30
REDIS_CONNECTION_STRING=redis_host:6379,password=your_redis_password,ssl=false,abortConnect=false
```

## 🛠️ 快速修复脚本

### 创建修复脚本

```bash
#!/bin/bash
# fix-container-issues.sh

echo "🔧 修复容器运行问题..."

# 1. 创建日志目录并设置权限
echo "创建日志目录..."
mkdir -p logs
chmod 755 logs
sudo chown -R $USER:$USER logs

# 2. 检查并创建.env文件
if [ ! -f ".env" ]; then
    echo "创建环境变量文件..."
    cp env.api-only.example .env
    echo "⚠️  请编辑 .env 文件，配置正确的数据库和Redis连接信息"
    echo "   数据库连接示例: Host=host.docker.internal;Port=5432;..."
    echo "   Redis连接示例: host.docker.internal:6379,password=..."
    exit 1
fi

# 3. 检查环境变量配置
echo "检查环境变量配置..."
if grep -q "localhost" .env; then
    echo "⚠️  发现localhost配置，请修改为正确的网络地址"
    echo "   建议使用: host.docker.internal 或具体的IP地址"
fi

# 4. 重新构建镜像
echo "重新构建Docker镜像..."
docker build -f LLX.Server/Dockerfile -t llxrice/api:latest .

# 5. 停止现有容器
echo "停止现有容器..."
docker stop llxrice_api 2>/dev/null || true
docker rm llxrice_api 2>/dev/null || true

# 6. 启动服务
echo "启动服务..."
docker-compose -f docker-compose.api-only.yml up -d

echo "✅ 修复完成！"
echo "请检查服务状态: docker logs llxrice_api"
```

### 使用修复脚本

```bash
# 给脚本执行权限
chmod +x fix-container-issues.sh

# 执行修复
./fix-container-issues.sh
```

## 🔍 验证修复

### 1. 检查容器状态

```bash
# 查看容器状态
docker ps --filter "name=llxrice_api"

# 查看容器日志
docker logs llxrice_api

# 进入容器检查权限
docker exec -it llxrice_api ls -la /app/logs
```

### 2. 检查网络连接

```bash
# 测试数据库连接
docker exec llxrice_api ping host.docker.internal

# 测试Redis连接
docker exec llxrice_api telnet host.docker.internal 6379
```

### 3. 检查健康状态

```bash
# 健康检查
curl http://localhost:8080/health

# 查看详细健康信息
curl http://localhost:8080/health | jq .
```

## 🚨 常见问题解决

### 1. 权限问题持续存在

```bash
# 检查宿主机目录权限
ls -la logs/

# 修复权限
sudo chown -R 1000:1000 logs/
chmod -R 755 logs/
```

### 2. 网络连接问题

```bash
# 检查Docker网络
docker network ls
docker network inspect bridge

# 使用host网络模式（临时）
docker run --network host llxrice/api:latest
```

### 3. 数据库连接问题

```bash
# 检查数据库是否运行
docker ps | grep postgres
netstat -tlnp | grep 5432

# 测试数据库连接
psql -h localhost -p 5432 -U llxrice_user -d llxrice
```

### 4. Redis连接问题

```bash
# 检查Redis是否运行
docker ps | grep redis
netstat -tlnp | grep 6379

# 测试Redis连接
redis-cli -h localhost -p 6379 ping
```

## 📋 最佳实践

### 1. 网络配置

- **开发环境**：使用 `host.docker.internal`
- **生产环境**：使用具体的IP地址或服务名
- **Docker Compose**：使用服务名作为主机名

### 2. 权限管理

- 确保日志目录权限正确
- 使用非root用户运行容器
- 正确设置文件所有权

### 3. 环境变量

- 使用 `.env` 文件管理配置
- 避免硬编码敏感信息
- 为不同环境使用不同配置

### 4. 监控和日志

- 定期检查容器日志
- 监控资源使用情况
- 设置健康检查

## 📞 技术支持

如果问题仍然存在，请提供以下信息：

1. 容器日志：`docker logs llxrice_api`
2. 环境配置：`cat .env`
3. 系统信息：`docker version` 和 `docker-compose version`
4. 网络配置：`docker network ls`

---

**文档版本**：v1.0  
**最后更新**：2025-10-22  
**适用环境**：Linux, Docker, Docker Compose
