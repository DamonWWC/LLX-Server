# 林龍香大米商城 - 后端服务快速开始指南

## 📦 交付清单

本次交付包含以下完整文档和脚本:

### 📄 核心文档

1. **后端服务设计方案.md** - 完整的技术架构和设计方案
   - 系统架构设计
   - 技术栈说明和选型理由
   - 数据库设计（ER图、表结构）
   - API接口设计（RESTful规范）
   - Redis缓存策略
   - 核心代码实现示例

2. **数据库初始化脚本.sql** - PostgreSQL数据库完整初始化脚本
   - 表结构创建
   - 索引创建
   - 触发器（自动更新时间戳）
   - 视图（便于查询）
   - 存储过程/函数
   - 初始数据插入

3. **DEPLOYMENT.md** - 详细部署指南
   - Docker Compose 部署（推荐）
   - Systemd 服务部署
   - 配置说明
   - 健康检查
   - 监控和日志
   - 备份和恢复
   - 故障排除

4. **README-Backend.md** - 项目概述文档
   - 项目介绍
   - 功能特性
   - 快速开始
   - API文档
   - 小程序对接说明

5. **.cursorrules** - Cursor AI 开发规则
   - 代码规范
   - 架构模式
   - 最佳实践
   - 常用命令

### 🔧 配置文件

6. **docker-compose.yml** - Docker Compose 编排配置
7. **Dockerfile** - Docker 镜像构建配置
8. **.dockerignore** - Docker 构建忽略文件
9. **env.example** - 环境变量示例文件

---

## 🚀 5分钟快速部署

### 前置要求

- Linux 服务器（Ubuntu 20.04/22.04, CentOS 7/8）
- Docker 20.10+
- Docker Compose 2.0+

### 部署步骤

#### 1. 安装 Docker（如未安装）

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装 Docker Compose
sudo apt install -y docker-compose-plugin

# 验证安装
docker --version
docker compose version
```

#### 2. 准备项目文件

```bash
# 创建项目目录
sudo mkdir -p /opt/llxrice-api
cd /opt/llxrice-api

# 上传以下文件到服务器:
# - docker-compose.yml
# - Dockerfile
# - .dockerignore
# - 数据库初始化脚本.sql
# - env.example

# 或使用 git clone（如果有仓库）
# git clone <repository-url> .
```

#### 3. 配置环境变量

```bash
# 复制示例配置
cp env.example .env

# 编辑配置文件，修改密码
nano .env

# 必须修改的配置:
# DB_PASSWORD=生成一个强密码
# REDIS_PASSWORD=生成另一个强密码

# 生成强密码的方法:
# openssl rand -base64 32
```

#### 4. 启动服务

```bash
# 启动所有服务
docker compose up -d

# 查看服务状态
docker compose ps

# 查看日志
docker compose logs -f
```

#### 5. 验证部署

```bash
# 健康检查
curl http://localhost:8080/health

# 应该返回:
# {"status":"Healthy",...}

# 访问 Swagger 文档
# 浏览器打开: http://<服务器IP>:8080
```

✅ **完成！** 后端服务已经运行在 `http://<服务器IP>:8080`

---

## 📱 小程序对接

### 1. 配置服务器域名

在微信公众平台配置:

```
开发 -> 开发管理 -> 开发设置 -> 服务器域名
request合法域名: https://api.llxrice.com
```

**注意**: 需要配置 SSL 证书，参考 [DEPLOYMENT.md](./DEPLOYMENT.md#8-配置-ssl使用-lets-encrypt)

### 2. 修改小程序配置

在小程序 `utils/httpClient.js` 中修改:

```javascript
// 修改 API 基础地址
const BASE_URL = 'https://api.llxrice.com/api'

// 或者开发环境使用 IP 地址
// const BASE_URL = 'http://192.168.1.100:8080/api'
```

### 3. 测试对接

```javascript
// 在小程序中测试
const ApiService = require('../../utils/apiService.js')

// 测试获取商品列表
const products = await ApiService.getProducts()
console.log('商品列表:', products)
```

---

## 🔍 验证部署

### 检查服务状态

```bash
# 查看容器状态
docker compose ps

# 所有服务应该是 Up (healthy)
# NAME              STATUS
# llxrice_api       Up (healthy)
# llxrice_db        Up (healthy)
# llxrice_redis     Up (healthy)
```

### 测试 API 接口

```bash
# 1. 获取商品列表
curl http://localhost:8080/api/products

# 2. 健康检查
curl http://localhost:8080/health

# 3. 计算运费
curl -X POST http://localhost:8080/api/shipping/calculate \
  -H "Content-Type: application/json" \
  -d '{"province":"广东省","weight":20}'
```

### 查看日志

```bash
# 实时查看 API 日志
docker compose logs -f api

# 查看数据库日志
docker compose logs -f postgres

# 查看 Redis 日志
docker compose logs -f redis
```

---

## 📊 技术架构

```
┌─────────────────┐
│  微信小程序      │
└────────┬────────┘
         │ HTTPS
         │
┌────────▼────────┐
│   Nginx (可选)  │
└────────┬────────┘
         │
┌────────▼────────────────────┐
│   .NET 8 Minimal API        │
│   (Container: llxrice_api)  │
└────┬──────────────────┬─────┘
     │                  │
┌────▼──────┐    ┌─────▼──────┐
│PostgreSQL │    │   Redis    │
│   (DB)    │    │  (Cache)   │
└───────────┘    └────────────┘
```

### 端口映射

| 服务 | 容器端口 | 主机端口 | 说明 |
|------|---------|---------|------|
| API | 8080 | 8080 | API 服务 |
| PostgreSQL | 5432 | 5432 | 数据库（可关闭外部访问） |
| Redis | 6379 | 6379 | 缓存（可关闭外部访问） |

### 数据持久化

数据通过 Docker Volume 持久化:

- `postgres_data`: PostgreSQL 数据
- `redis_data`: Redis 数据
- `./logs`: 应用日志

---

## 🛠️ 常用管理命令

### Docker 管理

```bash
# 停止所有服务
docker compose down

# 重启所有服务
docker compose restart

# 重启单个服务
docker compose restart api

# 查看资源使用
docker stats

# 进入容器
docker exec -it llxrice_api sh

# 查看日志（最近100条）
docker compose logs --tail=100 api
```

### 数据库管理

```bash
# 连接数据库
docker exec -it llxrice_db psql -U llxrice_user -d llxrice

# 备份数据库
docker exec llxrice_db pg_dump -U llxrice_user llxrice > backup_$(date +%Y%m%d).sql

# 恢复数据库
docker exec -i llxrice_db psql -U llxrice_user llxrice < backup_20251017.sql

# 查看数据库大小
docker exec -it llxrice_db psql -U llxrice_user -d llxrice -c "SELECT pg_size_pretty(pg_database_size('llxrice'));"
```

### 应用更新

```bash
# 拉取最新代码
git pull

# 重新构建并启动
docker compose up -d --build

# 只重启 API 服务
docker compose restart api
```

---

## 📈 性能优化建议

### 1. 数据库优化

```bash
# 连接数据库
docker exec -it llxrice_db psql -U llxrice_user -d llxrice

# 分析表统计信息
ANALYZE;

# 清理和优化
VACUUM;

# 查看慢查询（如果启用了 pg_stat_statements）
SELECT * FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;
```

### 2. Redis 优化

```bash
# 查看内存使用
docker exec -it llxrice_redis redis-cli -a your_password INFO memory

# 清理所有缓存（谨慎使用）
docker exec -it llxrice_redis redis-cli -a your_password FLUSHALL
```

### 3. 应用优化

- ✅ 启用 Redis 缓存（已配置）
- ✅ 使用连接池（已配置）
- ✅ 异步编程（代码规范要求）
- ✅ 分页查询（避免大数据量）

---

## 🔐 安全配置

### 1. 修改默认密码

```bash
# 编辑 .env 文件
nano .env

# 生成强密码
openssl rand -base64 32
```

### 2. 配置防火墙

```bash
# 只开放必要端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# 关闭数据库对外访问（推荐）
# 修改 docker-compose.yml，删除 ports 映射
```

### 3. 配置 SSL 证书

```bash
# 使用 Let's Encrypt
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d api.llxrice.com
```

---

## 📞 技术支持

### 遇到问题？

1. **查看日志**
   ```bash
   docker compose logs -f api
   ```

2. **检查服务状态**
   ```bash
   docker compose ps
   curl http://localhost:8080/health
   ```

3. **参考文档**
   - [后端服务设计方案.md](./后端服务设计方案.md)
   - [DEPLOYMENT.md](./DEPLOYMENT.md)
   - [故障排除](./DEPLOYMENT.md#故障排除)

### 常见问题

#### Q1: 服务启动失败？
**A**: 检查端口是否被占用
```bash
sudo netstat -tulpn | grep -E ':(8080|5432|6379)'
```

#### Q2: 数据库连接失败？
**A**: 检查密码配置和容器状态
```bash
docker compose logs postgres
cat .env
```

#### Q3: 小程序无法连接？
**A**: 检查域名配置和 SSL 证书
- 必须使用 HTTPS
- 域名必须在微信公众平台配置

---

## 📚 完整文档列表

1. ✅ [后端服务设计方案.md](./后端服务设计方案.md) - 技术设计
2. ✅ [数据库初始化脚本.sql](./数据库初始化脚本.sql) - 数据库脚本
3. ✅ [DEPLOYMENT.md](./DEPLOYMENT.md) - 部署指南
4. ✅ [README-Backend.md](./README-Backend.md) - 项目说明
5. ✅ [.cursorrules](./.cursorrules) - 开发规则
6. ✅ [docker-compose.yml](./docker-compose.yml) - Docker配置
7. ✅ [Dockerfile](./Dockerfile) - 镜像配置

---

## 🎯 下一步

部署完成后，建议：

1. ✅ **配置域名和 SSL** - 参考 [DEPLOYMENT.md](./DEPLOYMENT.md#8-配置-ssl使用-lets-encrypt)
2. ✅ **设置定时备份** - 参考 [DEPLOYMENT.md](./DEPLOYMENT.md#自动备份脚本)
3. ✅ **配置监控告警** - 使用健康检查脚本
4. ✅ **开发小程序对接** - 参考 API 文档
5. ✅ **性能测试** - 压力测试和优化

---

## 🌟 核心优势

### 为什么选择这个方案？

1. **现代化技术栈**
   - .NET 8 Minimal API - 性能提升 20%+
   - PostgreSQL 16 - 功能强大，开源免费
   - Redis 7.2 - 高性能缓存

2. **易于部署**
   - Docker Compose 一键部署
   - 自动健康检查
   - 数据持久化

3. **易于维护**
   - 清晰的分层架构
   - 完整的开发规范
   - 详细的文档

4. **生产就绪**
   - 日志记录
   - 错误处理
   - 性能优化
   - 安全配置

5. **可扩展性**
   - 预留鉴权接口
   - 支持水平扩展
   - 微服务友好

---

## ✨ 特色功能

- 🎯 **智能地址识别**: 自动解析省市区，支持多种格式
- 🚀 **Redis 缓存**: 热点数据缓存，响应速度快
- 📊 **运费计算**: 基于省份和重量的动态计算
- 📝 **结构化日志**: 便于分析和查询
- 🔍 **健康检查**: 自动监控服务状态
- 📖 **Swagger 文档**: 自动生成 API 文档

---

<div align="center">

**🎉 恭喜！您已经拥有一个完整的生产级后端服务方案！**

如有任何问题，请参考完整文档或联系技术支持。

Made with ❤️ by LLXRice Team

</div>

---

**文档版本**: v1.0  
**最后更新**: 2025-10-17  
**适用版本**: .NET 8 + PostgreSQL 16 + Redis 7.2

---

© 2025 林龍香大米商城. All rights reserved.

