# å¤šç¯å¢ƒé…ç½®ç®¡ç†æŒ‡å—

## ğŸŒ åœ¨ä¸åŒç¯å¢ƒåŠ è½½ä¸åŒçš„ .env æ–‡ä»¶

### ğŸ“ 1. åˆ›å»ºä¸åŒç¯å¢ƒçš„ .env æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºå¤šä¸ªç¯å¢ƒé…ç½®æ–‡ä»¶ï¼š

```bash
# é¡¹ç›®æ ¹ç›®å½•ç»“æ„
E:\èµ„æ–™\å­¦ä¹ ä»£ç \LLX.Server\
â”œâ”€â”€ .env                          # é»˜è®¤ç¯å¢ƒï¼ˆå¼€å‘ç¯å¢ƒï¼‰
â”œâ”€â”€ .env.development              # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ .env.staging                  # é¢„å‘å¸ƒç¯å¢ƒ
â”œâ”€â”€ .env.production               # ç”Ÿäº§ç¯å¢ƒ
â”œâ”€â”€ .env.test                     # æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ docker-compose.api-only.yml   # Docker Compose é…ç½®
â””â”€â”€ LLX.Server\                   # .NET é¡¹ç›®ç›®å½•
```

### ğŸ¯ 2. ä¸åŒç¯å¢ƒçš„ .env æ–‡ä»¶å†…å®¹

#### å¼€å‘ç¯å¢ƒ (.env.development)
```bash
# .env.development
# å¼€å‘ç¯å¢ƒé…ç½®

# .NET Core ç¯å¢ƒ
ASPNETCORE_ENVIRONMENT=Development
ASPNETCORE_URLS=http://localhost:5000

# æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² (æœ¬åœ°å¼€å‘æ•°æ®åº“)
DB_CONNECTION_STRING=Host=localhost;Port=5432;Database=llxrice_dev;Username=llxrice_user;Password=dev_password;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30

# Redis ç¼“å­˜è¿æ¥å­—ç¬¦ä¸² (æœ¬åœ°å¼€å‘Redis)
REDIS_CONNECTION_STRING=localhost:6379,password=dev_redis_password,ssl=false,abortConnect=false

# æ•°æ®åº“æä¾›è€…
DB_PROVIDER=PostgreSQL

# æ—¥å¿—çº§åˆ« (å¼€å‘ç¯å¢ƒä½¿ç”¨è¯¦ç»†æ—¥å¿—)
Logging__LogLevel__Default=Debug
Logging__LogLevel__Microsoft=Information
Logging__LogLevel__System=Warning

# æ€§èƒ½é…ç½®
Performance__SlowRequestThreshold=1000

# æ•°æ®åº“è¿æ¥æ± é…ç½®
Database__ConnectionPool__MinPoolSize=5
Database__ConnectionPool__MaxPoolSize=100
Database__ConnectionPool__ConnectionLifetime=300
Database__ConnectionPool__CommandTimeout=30
Database__ConnectionPool__EnableRetryOnFailure=true
Database__ConnectionPool__MaxRetryCount=3
```

#### é¢„å‘å¸ƒç¯å¢ƒ (.env.staging)
```bash
# .env.staging
# é¢„å‘å¸ƒç¯å¢ƒé…ç½®

# .NET Core ç¯å¢ƒ
ASPNETCORE_ENVIRONMENT=Staging
ASPNETCORE_URLS=http://+:8080

# æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² (é¢„å‘å¸ƒæ•°æ®åº“)
DB_CONNECTION_STRING=Host=staging-db.example.com;Port=5432;Database=llxrice_staging;Username=llxrice_user;Password=staging_password;Pooling=true;Minimum Pool Size=10;Maximum Pool Size=200;Command Timeout=30

# Redis ç¼“å­˜è¿æ¥å­—ç¬¦ä¸² (é¢„å‘å¸ƒRedis)
REDIS_CONNECTION_STRING=staging-redis.example.com:6379,password=staging_redis_password,ssl=true,abortConnect=false

# æ•°æ®åº“æä¾›è€…
DB_PROVIDER=PostgreSQL

# æ—¥å¿—çº§åˆ« (é¢„å‘å¸ƒç¯å¢ƒä½¿ç”¨ä¿¡æ¯çº§åˆ«)
Logging__LogLevel__Default=Information
Logging__LogLevel__Microsoft=Warning
Logging__LogLevel__System=Error

# æ€§èƒ½é…ç½®
Performance__SlowRequestThreshold=2000

# æ•°æ®åº“è¿æ¥æ± é…ç½®
Database__ConnectionPool__MinPoolSize=10
Database__ConnectionPool__MaxPoolSize=200
Database__ConnectionPool__ConnectionLifetime=600
Database__ConnectionPool__CommandTimeout=60
Database__ConnectionPool__EnableRetryOnFailure=true
Database__ConnectionPool__MaxRetryCount=5
```

#### ç”Ÿäº§ç¯å¢ƒ (.env.production)
```bash
# .env.production
# ç”Ÿäº§ç¯å¢ƒé…ç½®

# .NET Core ç¯å¢ƒ
ASPNETCORE_ENVIRONMENT=Production
ASPNETCORE_URLS=http://+:8080

# æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² (ç”Ÿäº§æ•°æ®åº“)
DB_CONNECTION_STRING=Host=prod-db.example.com;Port=5432;Database=llxrice_prod;Username=llxrice_user;Password=prod_password;Pooling=true;Minimum Pool Size=20;Maximum Pool Size=500;Command Timeout=30

# Redis ç¼“å­˜è¿æ¥å­—ç¬¦ä¸² (ç”Ÿäº§Redis)
REDIS_CONNECTION_STRING=prod-redis.example.com:6379,password=prod_redis_password,ssl=true,abortConnect=false

# æ•°æ®åº“æä¾›è€…
DB_PROVIDER=PostgreSQL

# æ—¥å¿—çº§åˆ« (ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è­¦å‘Šçº§åˆ«)
Logging__LogLevel__Default=Warning
Logging__LogLevel__Microsoft=Error
Logging__LogLevel__System=Error

# æ€§èƒ½é…ç½®
Performance__SlowRequestThreshold=5000

# æ•°æ®åº“è¿æ¥æ± é…ç½®
Database__ConnectionPool__MinPoolSize=20
Database__ConnectionPool__MaxPoolSize=500
Database__ConnectionPool__ConnectionLifetime=1800
Database__ConnectionPool__CommandTimeout=120
Database__ConnectionPool__EnableRetryOnFailure=true
Database__ConnectionPool__MaxRetryCount=10
```

### ğŸš€ 3. éƒ¨ç½²è„šæœ¬æ”¯æŒå¤šç¯å¢ƒ

#### ä¿®æ”¹ deploy-api-only.sh è„šæœ¬

```bash
#!/bin/bash

# é»˜è®¤å‚æ•°
ENVIRONMENT="production"
ENV_FILE=""

# è§£æå‘½ä»¤è¡Œå‚æ•°
while [[ $# -gt 0 ]]; do
    case $1 in
        -e|--environment)
            ENVIRONMENT="$2"
            shift 2
            ;;
        --env-file)
            ENV_FILE="$2"
            shift 2
            ;;
        *)
            shift
            ;;
    esac
done

# ç¡®å®šç¯å¢ƒæ–‡ä»¶
determine_env_file() {
    if [ -n "$ENV_FILE" ]; then
        # ç”¨æˆ·æŒ‡å®šäº†ç¯å¢ƒæ–‡ä»¶
        ENV_FILE_PATH="$ENV_FILE"
    else
        # æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©
        case $ENVIRONMENT in
            "development")
                ENV_FILE_PATH=".env.development"
                ;;
            "staging")
                ENV_FILE_PATH=".env.staging"
                ;;
            "production")
                ENV_FILE_PATH=".env.production"
                ;;
            "test")
                ENV_FILE_PATH=".env.test"
                ;;
            *)
                ENV_FILE_PATH=".env"
                ;;
        esac
    fi
    
    # æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$ENV_FILE_PATH" ]; then
        print_color "red" "âœ— ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨: $ENV_FILE_PATH"
        return 1
    fi
    
    print_color "green" "âœ“ ä½¿ç”¨ç¯å¢ƒæ–‡ä»¶: $ENV_FILE_PATH"
    return 0
}

# å¯åŠ¨APIæœåŠ¡
start_api_service() {
    print_color "cyan" "\nå¯åŠ¨APIæœåŠ¡..."
    
    if [ ! -f "docker-compose.api-only.yml" ]; then
        print_color "red" "âœ— æ‰¾ä¸åˆ° docker-compose.api-only.yml æ–‡ä»¶"
        return 1
    fi
    
    # ä½¿ç”¨æŒ‡å®šçš„ç¯å¢ƒæ–‡ä»¶å¯åŠ¨
    if docker-compose --env-file "$ENV_FILE_PATH" -f docker-compose.api-only.yml up -d; then
        print_color "green" "âœ“ APIæœåŠ¡å¯åŠ¨æˆåŠŸ"
        return 0
    else
        print_color "red" "âœ— APIæœåŠ¡å¯åŠ¨å¤±è´¥"
        return 1
    fi
}
```

### ğŸ”§ 4. ä½¿ç”¨æ–¹æ³•

#### æ–¹æ³•1ï¼šé€šè¿‡ç¯å¢ƒå‚æ•°æŒ‡å®š
```bash
# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
./deploy-api-only.sh -e development

# éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
./deploy-api-only.sh -e staging

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
./deploy-api-only.sh -e production

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
./deploy-api-only.sh -e test
```

#### æ–¹æ³•2ï¼šé€šè¿‡ç¯å¢ƒæ–‡ä»¶å‚æ•°æŒ‡å®š
```bash
# ä½¿ç”¨è‡ªå®šä¹‰ç¯å¢ƒæ–‡ä»¶
./deploy-api-only.sh --env-file .env.custom

# ä½¿ç”¨ç‰¹å®šç¯å¢ƒæ–‡ä»¶
./deploy-api-only.sh --env-file .env.staging
```

#### æ–¹æ³•3ï¼šç›´æ¥ä½¿ç”¨ Docker Compose
```bash
# ä½¿ç”¨ç‰¹å®šç¯å¢ƒæ–‡ä»¶å¯åŠ¨
docker-compose --env-file .env.staging -f docker-compose.api-only.yml up -d

# ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒæ–‡ä»¶å¯åŠ¨
docker-compose --env-file .env.production -f docker-compose.api-only.yml up -d
```

### ğŸ¯ 5. åˆ›å»ºç¯å¢ƒç®¡ç†è„šæœ¬

#### åˆ›å»ºç¯å¢ƒåˆ‡æ¢è„šæœ¬
```bash
#!/bin/bash
# switch-environment.sh

ENVIRONMENT=$1

if [ -z "$ENVIRONMENT" ]; then
    echo "ç”¨æ³•: ./switch-environment.sh <environment>"
    echo "æ”¯æŒçš„ç¯å¢ƒ: development, staging, production, test"
    exit 1
fi

# æ£€æŸ¥ç¯å¢ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨
ENV_FILE=".env.$ENVIRONMENT"
if [ ! -f "$ENV_FILE" ]; then
    echo "é”™è¯¯: ç¯å¢ƒæ–‡ä»¶ $ENV_FILE ä¸å­˜åœ¨"
    exit 1
fi

# å¤åˆ¶ç¯å¢ƒæ–‡ä»¶ä¸ºé»˜è®¤ .env
cp "$ENV_FILE" ".env"
echo "âœ“ å·²åˆ‡æ¢åˆ° $ENVIRONMENT ç¯å¢ƒ"
echo "âœ“ ä½¿ç”¨é…ç½®æ–‡ä»¶: $ENV_FILE"
```

#### ä½¿ç”¨æ–¹æ³•
```bash
# åˆ‡æ¢åˆ°å¼€å‘ç¯å¢ƒ
./switch-environment.sh development

# åˆ‡æ¢åˆ°ç”Ÿäº§ç¯å¢ƒ
./switch-environment.sh production
```

### ğŸ§ª 6. éªŒè¯å¤šç¯å¢ƒé…ç½®

#### åˆ›å»ºç¯å¢ƒéªŒè¯è„šæœ¬
```bash
#!/bin/bash
# verify-environments.sh

echo "=== éªŒè¯å¤šç¯å¢ƒé…ç½® ==="

# æ£€æŸ¥æ‰€æœ‰ç¯å¢ƒæ–‡ä»¶
for env in development staging production test; do
    env_file=".env.$env"
    if [ -f "$env_file" ]; then
        echo "âœ… $env_file å­˜åœ¨"
        
        # æ£€æŸ¥å…³é”®é…ç½®é¡¹
        if grep -q "DB_CONNECTION_STRING" "$env_file"; then
            echo "  âœ“ æ•°æ®åº“è¿æ¥é…ç½®å­˜åœ¨"
        else
            echo "  âŒ æ•°æ®åº“è¿æ¥é…ç½®ç¼ºå¤±"
        fi
        
        if grep -q "REDIS_CONNECTION_STRING" "$env_file"; then
            echo "  âœ“ Redisè¿æ¥é…ç½®å­˜åœ¨"
        else
            echo "  âŒ Redisè¿æ¥é…ç½®ç¼ºå¤±"
        fi
    else
        echo "âŒ $env_file ä¸å­˜åœ¨"
    fi
    echo
done
```

### ğŸ“‹ 7. æœ€ä½³å®è·µ

#### 1. **ç¯å¢ƒæ–‡ä»¶å‘½åè§„èŒƒ**
```bash
.env                    # é»˜è®¤ç¯å¢ƒï¼ˆå¼€å‘ç¯å¢ƒï¼‰
.env.development        # å¼€å‘ç¯å¢ƒ
.env.staging           # é¢„å‘å¸ƒç¯å¢ƒ
.env.production        # ç”Ÿäº§ç¯å¢ƒ
.env.test              # æµ‹è¯•ç¯å¢ƒ
.env.local             # æœ¬åœ°ç¯å¢ƒï¼ˆä¸æäº¤åˆ°Gitï¼‰
```

#### 2. **Git å¿½ç•¥é…ç½®**
```bash
# .gitignore
.env
.env.local
.env.*.local

# ä¿ç•™ç¯å¢ƒæ¨¡æ¿æ–‡ä»¶
!.env.example
!.env.*.example
```

#### 3. **ç¯å¢ƒæ–‡ä»¶æ¨¡æ¿**
```bash
# .env.example
# ç¯å¢ƒå˜é‡æ¨¡æ¿æ–‡ä»¶

# .NET Core ç¯å¢ƒ
ASPNETCORE_ENVIRONMENT=Development
ASPNETCORE_URLS=http://localhost:5000

# æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
DB_CONNECTION_STRING=Host=localhost;Port=5432;Database=llxrice;Username=llxrice_user;Password=your_password;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30

# Redis ç¼“å­˜è¿æ¥å­—ç¬¦ä¸²
REDIS_CONNECTION_STRING=localhost:6379,password=your_redis_password,ssl=false,abortConnect=false

# æ•°æ®åº“æä¾›è€…
DB_PROVIDER=PostgreSQL

# æ—¥å¿—çº§åˆ«
Logging__LogLevel__Default=Information
Logging__LogLevel__Microsoft=Warning
Logging__LogLevel__System=Error

# æ€§èƒ½é…ç½®
Performance__SlowRequestThreshold=1000

# æ•°æ®åº“è¿æ¥æ± é…ç½®
Database__ConnectionPool__MinPoolSize=5
Database__ConnectionPool__MaxPoolSize=100
Database__ConnectionPool__ConnectionLifetime=300
Database__ConnectionPool__CommandTimeout=30
Database__ConnectionPool__EnableRetryOnFailure=true
Database__ConnectionPool__MaxRetryCount=3
```

### ğŸ‰ æ€»ç»“

**å®ç°å¤šç¯å¢ƒ .env æ–‡ä»¶åŠ è½½çš„æ–¹æ³•ï¼š**

1. âœ… **åˆ›å»ºå¤šä¸ªç¯å¢ƒæ–‡ä»¶**ï¼š`.env.development`ã€`.env.staging`ã€`.env.production`
2. âœ… **ä½¿ç”¨ `--env-file` å‚æ•°**ï¼š`docker-compose --env-file .env.staging up -d`
3. âœ… **ä¿®æ”¹éƒ¨ç½²è„šæœ¬**ï¼šæ”¯æŒç¯å¢ƒå‚æ•°é€‰æ‹©
4. âœ… **åˆ›å»ºç¯å¢ƒç®¡ç†è„šæœ¬**ï¼šç®€åŒ–ç¯å¢ƒåˆ‡æ¢
5. âœ… **éµå¾ªå‘½åè§„èŒƒ**ï¼š`.env.{environment}` æ ¼å¼

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```bash
# å¼€å‘ç¯å¢ƒ
./deploy-api-only.sh -e development

# ç”Ÿäº§ç¯å¢ƒ
./deploy-api-only.sh -e production

# è‡ªå®šä¹‰ç¯å¢ƒæ–‡ä»¶
docker-compose --env-file .env.custom up -d
```

è¿™æ ·æ‚¨å°±å¯ä»¥è½»æ¾ç®¡ç†ä¸åŒç¯å¢ƒçš„é…ç½®äº†ï¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [APIæœåŠ¡ç‹¬ç«‹éƒ¨ç½²æŒ‡å—](./APIæœåŠ¡ç‹¬ç«‹éƒ¨ç½²æŒ‡å—.md)
- [APIæœåŠ¡Linuxéƒ¨ç½²æŒ‡å—](./APIæœåŠ¡Linuxéƒ¨ç½²æŒ‡å—.md)
- [.NET Coreé…ç½®ç³»ç»Ÿè¯¦è§£](./NET%20Coreé…ç½®ç³»ç»Ÿè¯¦è§£.md)
- [å®¹å™¨è¿è¡Œé—®é¢˜ä¿®å¤æŒ‡å—](./å®¹å™¨è¿è¡Œé—®é¢˜ä¿®å¤æŒ‡å—.md)

## ğŸ”— å¿«é€Ÿé“¾æ¥

- [è¿”å›æ–‡æ¡£é¦–é¡µ](../README.md)
- [éƒ¨ç½²æ–¹æ¡ˆæ€»ç»“](./éƒ¨ç½²æ–¹æ¡ˆæ€»ç»“.md)
- [Linuxéƒ¨ç½²æ–¹æ¡ˆæ€»ç»“](./Linuxéƒ¨ç½²æ–¹æ¡ˆæ€»ç»“.md)
