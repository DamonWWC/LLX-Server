# 多环境配置管理指南

## 🌍 在不同环境加载不同的 .env 文件

### 📁 1. 创建不同环境的 .env 文件

在项目根目录创建多个环境配置文件：

```bash
# 项目根目录结构
E:\资料\学习代码\LLX.Server\
├── .env                          # 默认环境（开发环境）
├── .env.development              # 开发环境
├── .env.staging                  # 预发布环境
├── .env.production               # 生产环境
├── .env.test                     # 测试环境
├── docker-compose.api-only.yml   # Docker Compose 配置
└── LLX.Server\                   # .NET 项目目录
```

### 🎯 2. 不同环境的 .env 文件内容

#### 开发环境 (.env.development)
```bash
# .env.development
# 开发环境配置

# .NET Core 环境
ASPNETCORE_ENVIRONMENT=Development
ASPNETCORE_URLS=http://localhost:5000

# 数据库连接字符串 (本地开发数据库)
DB_CONNECTION_STRING=Host=localhost;Port=5432;Database=llxrice_dev;Username=llxrice_user;Password=dev_password;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30

# Redis 缓存连接字符串 (本地开发Redis)
REDIS_CONNECTION_STRING=localhost:6379,password=dev_redis_password,ssl=false,abortConnect=false

# 数据库提供者
DB_PROVIDER=PostgreSQL

# 日志级别 (开发环境使用详细日志)
Logging__LogLevel__Default=Debug
Logging__LogLevel__Microsoft=Information
Logging__LogLevel__System=Warning

# 性能配置
Performance__SlowRequestThreshold=1000

# 数据库连接池配置
Database__ConnectionPool__MinPoolSize=5
Database__ConnectionPool__MaxPoolSize=100
Database__ConnectionPool__ConnectionLifetime=300
Database__ConnectionPool__CommandTimeout=30
Database__ConnectionPool__EnableRetryOnFailure=true
Database__ConnectionPool__MaxRetryCount=3
```

#### 预发布环境 (.env.staging)
```bash
# .env.staging
# 预发布环境配置

# .NET Core 环境
ASPNETCORE_ENVIRONMENT=Staging
ASPNETCORE_URLS=http://+:8080

# 数据库连接字符串 (预发布数据库)
DB_CONNECTION_STRING=Host=staging-db.example.com;Port=5432;Database=llxrice_staging;Username=llxrice_user;Password=staging_password;Pooling=true;Minimum Pool Size=10;Maximum Pool Size=200;Command Timeout=30

# Redis 缓存连接字符串 (预发布Redis)
REDIS_CONNECTION_STRING=staging-redis.example.com:6379,password=staging_redis_password,ssl=true,abortConnect=false

# 数据库提供者
DB_PROVIDER=PostgreSQL

# 日志级别 (预发布环境使用信息级别)
Logging__LogLevel__Default=Information
Logging__LogLevel__Microsoft=Warning
Logging__LogLevel__System=Error

# 性能配置
Performance__SlowRequestThreshold=2000

# 数据库连接池配置
Database__ConnectionPool__MinPoolSize=10
Database__ConnectionPool__MaxPoolSize=200
Database__ConnectionPool__ConnectionLifetime=600
Database__ConnectionPool__CommandTimeout=60
Database__ConnectionPool__EnableRetryOnFailure=true
Database__ConnectionPool__MaxRetryCount=5
```

#### 生产环境 (.env.production)
```bash
# .env.production
# 生产环境配置

# .NET Core 环境
ASPNETCORE_ENVIRONMENT=Production
ASPNETCORE_URLS=http://+:8080

# 数据库连接字符串 (生产数据库)
DB_CONNECTION_STRING=Host=prod-db.example.com;Port=5432;Database=llxrice_prod;Username=llxrice_user;Password=prod_password;Pooling=true;Minimum Pool Size=20;Maximum Pool Size=500;Command Timeout=30

# Redis 缓存连接字符串 (生产Redis)
REDIS_CONNECTION_STRING=prod-redis.example.com:6379,password=prod_redis_password,ssl=true,abortConnect=false

# 数据库提供者
DB_PROVIDER=PostgreSQL

# 日志级别 (生产环境使用警告级别)
Logging__LogLevel__Default=Warning
Logging__LogLevel__Microsoft=Error
Logging__LogLevel__System=Error

# 性能配置
Performance__SlowRequestThreshold=5000

# 数据库连接池配置
Database__ConnectionPool__MinPoolSize=20
Database__ConnectionPool__MaxPoolSize=500
Database__ConnectionPool__ConnectionLifetime=1800
Database__ConnectionPool__CommandTimeout=120
Database__ConnectionPool__EnableRetryOnFailure=true
Database__ConnectionPool__MaxRetryCount=10
```

### 🚀 3. 部署脚本支持多环境

#### 修改 deploy-api-only.sh 脚本

```bash
#!/bin/bash

# 默认参数
ENVIRONMENT="production"
ENV_FILE=""

# 解析命令行参数
while [[ $# -gt 0 ]]; do
    case $1 in
        -e|--environment)
            ENVIRONMENT="$2"
            shift 2
            ;;
        --env-file)
            ENV_FILE="$2"
            shift 2
            ;;
        *)
            shift
            ;;
    esac
done

# 确定环境文件
determine_env_file() {
    if [ -n "$ENV_FILE" ]; then
        # 用户指定了环境文件
        ENV_FILE_PATH="$ENV_FILE"
    else
        # 根据环境自动选择
        case $ENVIRONMENT in
            "development")
                ENV_FILE_PATH=".env.development"
                ;;
            "staging")
                ENV_FILE_PATH=".env.staging"
                ;;
            "production")
                ENV_FILE_PATH=".env.production"
                ;;
            "test")
                ENV_FILE_PATH=".env.test"
                ;;
            *)
                ENV_FILE_PATH=".env"
                ;;
        esac
    fi
    
    # 检查环境文件是否存在
    if [ ! -f "$ENV_FILE_PATH" ]; then
        print_color "red" "✗ 环境文件不存在: $ENV_FILE_PATH"
        return 1
    fi
    
    print_color "green" "✓ 使用环境文件: $ENV_FILE_PATH"
    return 0
}

# 启动API服务
start_api_service() {
    print_color "cyan" "\n启动API服务..."
    
    if [ ! -f "docker-compose.api-only.yml" ]; then
        print_color "red" "✗ 找不到 docker-compose.api-only.yml 文件"
        return 1
    fi
    
    # 使用指定的环境文件启动
    if docker-compose --env-file "$ENV_FILE_PATH" -f docker-compose.api-only.yml up -d; then
        print_color "green" "✓ API服务启动成功"
        return 0
    else
        print_color "red" "✗ API服务启动失败"
        return 1
    fi
}
```

### 🔧 4. 使用方法

#### 方法1：通过环境参数指定
```bash
# 部署到开发环境
./deploy-api-only.sh -e development

# 部署到预发布环境
./deploy-api-only.sh -e staging

# 部署到生产环境
./deploy-api-only.sh -e production

# 部署到测试环境
./deploy-api-only.sh -e test
```

#### 方法2：通过环境文件参数指定
```bash
# 使用自定义环境文件
./deploy-api-only.sh --env-file .env.custom

# 使用特定环境文件
./deploy-api-only.sh --env-file .env.staging
```

#### 方法3：直接使用 Docker Compose
```bash
# 使用特定环境文件启动
docker-compose --env-file .env.staging -f docker-compose.api-only.yml up -d

# 使用生产环境文件启动
docker-compose --env-file .env.production -f docker-compose.api-only.yml up -d
```

### 🎯 5. 创建环境管理脚本

#### 创建环境切换脚本
```bash
#!/bin/bash
# switch-environment.sh

ENVIRONMENT=$1

if [ -z "$ENVIRONMENT" ]; then
    echo "用法: ./switch-environment.sh <environment>"
    echo "支持的环境: development, staging, production, test"
    exit 1
fi

# 检查环境文件是否存在
ENV_FILE=".env.$ENVIRONMENT"
if [ ! -f "$ENV_FILE" ]; then
    echo "错误: 环境文件 $ENV_FILE 不存在"
    exit 1
fi

# 复制环境文件为默认 .env
cp "$ENV_FILE" ".env"
echo "✓ 已切换到 $ENVIRONMENT 环境"
echo "✓ 使用配置文件: $ENV_FILE"
```

#### 使用方法
```bash
# 切换到开发环境
./switch-environment.sh development

# 切换到生产环境
./switch-environment.sh production
```

### 🧪 6. 验证多环境配置

#### 创建环境验证脚本
```bash
#!/bin/bash
# verify-environments.sh

echo "=== 验证多环境配置 ==="

# 检查所有环境文件
for env in development staging production test; do
    env_file=".env.$env"
    if [ -f "$env_file" ]; then
        echo "✅ $env_file 存在"
        
        # 检查关键配置项
        if grep -q "DB_CONNECTION_STRING" "$env_file"; then
            echo "  ✓ 数据库连接配置存在"
        else
            echo "  ❌ 数据库连接配置缺失"
        fi
        
        if grep -q "REDIS_CONNECTION_STRING" "$env_file"; then
            echo "  ✓ Redis连接配置存在"
        else
            echo "  ❌ Redis连接配置缺失"
        fi
    else
        echo "❌ $env_file 不存在"
    fi
    echo
done
```

### 📋 7. 最佳实践

#### 1. **环境文件命名规范**
```bash
.env                    # 默认环境（开发环境）
.env.development        # 开发环境
.env.staging           # 预发布环境
.env.production        # 生产环境
.env.test              # 测试环境
.env.local             # 本地环境（不提交到Git）
```

#### 2. **Git 忽略配置**
```bash
# .gitignore
.env
.env.local
.env.*.local

# 保留环境模板文件
!.env.example
!.env.*.example
```

#### 3. **环境文件模板**
```bash
# .env.example
# 环境变量模板文件

# .NET Core 环境
ASPNETCORE_ENVIRONMENT=Development
ASPNETCORE_URLS=http://localhost:5000

# 数据库连接字符串
DB_CONNECTION_STRING=Host=localhost;Port=5432;Database=llxrice;Username=llxrice_user;Password=your_password;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30

# Redis 缓存连接字符串
REDIS_CONNECTION_STRING=localhost:6379,password=your_redis_password,ssl=false,abortConnect=false

# 数据库提供者
DB_PROVIDER=PostgreSQL

# 日志级别
Logging__LogLevel__Default=Information
Logging__LogLevel__Microsoft=Warning
Logging__LogLevel__System=Error

# 性能配置
Performance__SlowRequestThreshold=1000

# 数据库连接池配置
Database__ConnectionPool__MinPoolSize=5
Database__ConnectionPool__MaxPoolSize=100
Database__ConnectionPool__ConnectionLifetime=300
Database__ConnectionPool__CommandTimeout=30
Database__ConnectionPool__EnableRetryOnFailure=true
Database__ConnectionPool__MaxRetryCount=3
```

### 🎉 总结

**实现多环境 .env 文件加载的方法：**

1. ✅ **创建多个环境文件**：`.env.development`、`.env.staging`、`.env.production`
2. ✅ **使用 `--env-file` 参数**：`docker-compose --env-file .env.staging up -d`
3. ✅ **修改部署脚本**：支持环境参数选择
4. ✅ **创建环境管理脚本**：简化环境切换
5. ✅ **遵循命名规范**：`.env.{environment}` 格式

**使用示例：**
```bash
# 开发环境
./deploy-api-only.sh -e development

# 生产环境
./deploy-api-only.sh -e production

# 自定义环境文件
docker-compose --env-file .env.custom up -d
```

这样您就可以轻松管理不同环境的配置了！

---

## 📚 相关文档

- [API服务独立部署指南](./API服务独立部署指南.md)
- [API服务Linux部署指南](./API服务Linux部署指南.md)
- [.NET Core配置系统详解](./NET%20Core配置系统详解.md)
- [容器运行问题修复指南](./容器运行问题修复指南.md)

## 🔗 快速链接

- [返回文档首页](../README.md)
- [部署方案总结](./部署方案总结.md)
- [Linux部署方案总结](./Linux部署方案总结.md)
