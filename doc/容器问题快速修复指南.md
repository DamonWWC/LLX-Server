# 容器问题快速修复指南

## 🚨 问题症状

在Linux容器中运行时出现以下错误：

```
Failed to write log: Access to the path '/app/logs/error-2025-10-22.log' is denied.
Failed to connect to 127.0.0.1:5432
UnableToConnect on localhost:6379
```

## ⚡ 快速修复（推荐）

### 方法一：使用修复脚本

#### Linux/Mac 环境

```bash
# 1. 进入项目根目录
cd /path/to/LLX.Server

# 2. 执行修复脚本
./LLX.Server/scripts/fix-container-issues.sh

# 3. 强制修复（不询问确认）
./LLX.Server/scripts/fix-container-issues.sh -f
```

#### Windows 环境

```powershell
# 1. 进入项目根目录
cd E:\资料\学习代码\LLX.Server

# 2. 执行修复脚本
.\LLX.Server\scripts\fix-container-issues.ps1

# 3. 强制修复（不询问确认）
.\LLX.Server\scripts\fix-container-issues.ps1 -Force
```

### 方法二：手动修复

#### 1. 修复日志权限

```bash
# 创建日志目录
mkdir -p logs
chmod 755 logs

# 设置正确的所有权
sudo chown -R $USER:$USER logs
```

#### 2. 修复网络连接

```bash
# 复制环境变量文件
cp env.api-only.example .env

# 编辑配置文件
vim .env
```

**修改关键配置**：

```bash
# 将 localhost 改为 host.docker.internal
DB_CONNECTION_STRING=Host=host.docker.internal;Port=5432;Database=llxrice;Username=llxrice_user;Password=your_password;Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100;Command Timeout=30

REDIS_CONNECTION_STRING=host.docker.internal:6379,password=your_redis_password,ssl=false,abortConnect=false
```

#### 3. 重新构建和启动

```bash
# 重新构建镜像
docker build -f LLX.Server/Dockerfile -t llxrice/api:latest .

# 停止现有容器
docker stop llxrice_api
docker rm llxrice_api

# 启动新服务
docker-compose -f docker-compose.api-only.yml up -d
```

## 🔍 验证修复

### 检查服务状态

```bash
# 查看容器状态
docker ps --filter "name=llxrice_api"

# 查看日志
docker logs llxrice_api

# 健康检查
curl http://localhost:8080/health
```

### 检查权限

```bash
# 检查日志目录权限
docker exec llxrice_api ls -la /app/logs

# 检查宿主机日志目录
ls -la logs/
```

## 🛠️ 常见问题解决

### 1. 权限问题持续存在

```bash
# 检查并修复权限
sudo chown -R 1000:1000 logs/
chmod -R 755 logs/

# 或者使用Docker用户ID
docker exec llxrice_api id
# 使用返回的UID:GID
```

### 2. 网络连接问题

```bash
# 检查Docker网络
docker network ls
docker network inspect bridge

# 测试连接
docker exec llxrice_api ping host.docker.internal
docker exec llxrice_api telnet host.docker.internal 5432
```

### 3. 数据库连接问题

```bash
# 检查数据库是否运行
docker ps | grep postgres
netstat -tlnp | grep 5432

# 测试数据库连接
psql -h localhost -p 5432 -U llxrice_user -d llxrice
```

### 4. Redis连接问题

```bash
# 检查Redis是否运行
docker ps | grep redis
netstat -tlnp | grep 6379

# 测试Redis连接
redis-cli -h localhost -p 6379 ping
```

## 🚀 一键修复命令

### 最常用的修复命令

```bash
# Linux/Mac - 自动修复所有问题
./LLX.Server/scripts/fix-container-issues.sh -f

# Windows - 自动修复所有问题
.\LLX.Server\scripts\fix-container-issues.ps1 -Force
```

### 仅重启服务

```bash
# Linux/Mac
./LLX.Server/scripts/fix-container-issues.sh -r

# Windows
.\LLX.Server\scripts\fix-container-issues.ps1 -RestartOnly
```

## 📋 修复检查清单

### 修复前检查

- [ ] 确认在项目根目录
- [ ] Docker服务正在运行
- [ ] 有管理员权限（Linux/Mac）

### 修复后验证

- [ ] 容器正常运行
- [ ] 日志文件可以写入
- [ ] 数据库连接正常
- [ ] Redis连接正常
- [ ] 健康检查通过
- [ ] API端点可访问

## 🎯 最佳实践

### 1. 网络配置

- **开发环境**：使用 `host.docker.internal`
- **生产环境**：使用具体的IP地址
- **Docker Compose**：使用服务名

### 2. 权限管理

- 确保日志目录权限正确
- 使用非root用户运行容器
- 正确设置文件所有权

### 3. 环境变量

- 使用 `.env` 文件管理配置
- 避免硬编码敏感信息
- 为不同环境使用不同配置

## 📞 技术支持

如果问题仍然存在，请提供：

1. **容器日志**：`docker logs llxrice_api`
2. **环境配置**：`cat .env`
3. **系统信息**：`docker version`
4. **网络配置**：`docker network ls`

---

**文档版本**：v1.0  
**最后更新**：2025-10-22  
**适用环境**：Linux, Windows, Docker
