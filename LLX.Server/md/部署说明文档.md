# 林龍香大米商城后端服务部署说明文档

## 📋 目录

1. [系统要求](#系统要求)
2. [环境准备](#环境准备)
3. [快速部署](#快速部署)
4. [详细部署步骤](#详细部署步骤)
5. [配置说明](#配置说明)
6. [服务验证](#服务验证)
7. [故障排除](#故障排除)
8. [维护指南](#维护指南)

---

## 🖥️ 系统要求

### 硬件要求

| 组件 | 最低配置 | 推荐配置 | 生产环境 |
|------|----------|----------|----------|
| **CPU** | 2核心 | 4核心 | 8核心+ |
| **内存** | 4GB | 8GB | 16GB+ |
| **存储** | 20GB | 50GB | 100GB+ |
| **网络** | 100Mbps | 1Gbps | 10Gbps+ |

### 软件要求

#### 必需软件
- **操作系统**: Windows 10/11, Linux (Ubuntu 20.04+), macOS 10.15+
- **Docker**: 20.10.0+
- **Docker Compose**: 2.0.0+
- **Git**: 2.30.0+

#### 推荐软件
- **IDE**: Visual Studio Code, Visual Studio 2022
- **数据库管理**: pgAdmin, DBeaver
- **Redis管理**: RedisInsight
- **API测试**: Postman, Insomnia

---

## 🔧 环境准备

### 1. 安装Docker

#### Windows
```powershell
# 下载并安装Docker Desktop
# 访问: https://www.docker.com/products/docker-desktop

# 验证安装
docker --version
docker-compose --version
```

#### Linux (Ubuntu)
```bash
# 更新包索引
sudo apt-get update

# 安装Docker
sudo apt-get install -y docker.io docker-compose

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 将用户添加到docker组
sudo usermod -aG docker $USER

# 验证安装
docker --version
docker-compose --version
```

#### macOS
```bash
# 使用Homebrew安装
brew install --cask docker

# 或者下载Docker Desktop for Mac
# 访问: https://www.docker.com/products/docker-desktop

# 验证安装
docker --version
docker-compose --version
```

### 2. 克隆项目

```bash
# 克隆项目到本地
git clone <repository-url>
cd LLX.Server

# 或者下载ZIP文件并解压
```

### 3. 检查项目结构

确保项目目录结构如下：
```
LLX.Server/
├── LLX.Server/           # 主项目目录
│   ├── Dockerfile        # Docker镜像构建文件
│   ├── scripts/          # 部署和测试脚本
│   └── ...
├── doc/                  # 文档目录
│   ├── docker-compose.yml # Docker编排文件
│   ├── env.example       # 环境变量示例
│   └── ...
└── README.md
```

---

## 🚀 快速部署

### 一键部署（推荐）

#### Windows PowerShell
```powershell
# 进入项目目录
cd LLX.Server

# 运行部署脚本
.\scripts\deploy.ps1

# 或者指定参数
.\scripts\deploy.ps1 -Environment production -Build -Force
```

#### Linux/Mac
```bash
# 进入项目目录
cd LLX.Server

# 给脚本执行权限
chmod +x scripts/deploy.sh

# 运行部署脚本
./scripts/deploy.sh

# 或者指定参数
./scripts/deploy.sh -e production -b -f
```

### 部署参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-Environment` / `-e` | 部署环境 (development/production) | production |
| `-Build` / `-b` | 强制重新构建镜像 | false |
| `-Pull` / `-p` | 拉取最新镜像 | false |
| `-Force` / `-f` | 强制重新部署 | false |
| `-Help` / `-h` | 显示帮助信息 | false |

---

## 📝 详细部署步骤

### 步骤1: 配置环境变量

```bash
# 复制环境变量示例文件
cp doc/env.example .env

# 编辑环境变量文件
nano .env  # Linux/Mac
notepad .env  # Windows
```

#### 关键配置项

```bash
# 数据库配置
DB_PASSWORD=your_strong_password_here
DB_MIN_POOL_SIZE=5
DB_MAX_POOL_SIZE=100

# Redis配置
REDIS_PASSWORD=your_redis_password_here
REDIS_MAX_MEMORY=256

# 应用配置
ASPNETCORE_ENVIRONMENT=Production
ASPNETCORE_URLS=http://+:8080

# 性能配置
PERFORMANCE_SLOW_REQUEST_THRESHOLD=1000
```

### 步骤2: 构建和启动服务

```bash
# 构建镜像
docker-compose build

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps
```

### 步骤3: 等待服务启动

```bash
# 查看服务日志
docker-compose logs -f

# 检查服务健康状态
curl http://localhost:8080/health
```

### 步骤4: 验证部署

```bash
# 运行API测试
.\scripts\test-api.ps1  # Windows
./scripts/test-api.sh   # Linux/Mac

# 运行数据库测试
.\scripts\test-database.ps1  # Windows
./scripts/test-database.sh   # Linux/Mac

# 运行缓存测试
.\scripts\test-cache.ps1  # Windows
./scripts/test-cache.sh   # Linux/Mac
```

---

## ⚙️ 配置说明

### Docker Compose配置

#### 服务配置
```yaml
services:
  # PostgreSQL数据库
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: llxrice
      POSTGRES_USER: llxrice_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Redis缓存
  redis:
    image: redis:7.2-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # API服务
  api:
    build:
      context: .
      dockerfile: LLX.Server/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=llxrice;Username=llxrice_user;Password=${DB_PASSWORD}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
```

#### 资源限制
```yaml
deploy:
  resources:
    limits:
      memory: 512M
      cpus: "0.5"
    reservations:
      memory: 256M
      cpus: "0.25"
```

### 环境变量配置

#### 数据库配置
```bash
# 连接字符串
ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=llxrice;Username=llxrice_user;Password=${DB_PASSWORD};Pooling=true;Minimum Pool Size=5;Maximum Pool Size=100

# 连接池配置
Database__ConnectionPool__MinPoolSize=5
Database__ConnectionPool__MaxPoolSize=100
Database__ConnectionPool__ConnectionLifetime=300
Database__ConnectionPool__CommandTimeout=30
```

#### 缓存配置
```bash
# Redis连接
ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD},ssl=false,abortConnect=false

# 缓存配置
REDIS_MAX_MEMORY=256
REDIS_MAX_MEMORY_POLICY=allkeys-lru
```

#### 性能配置
```bash
# 性能监控
Performance__SlowRequestThreshold=1000

# 日志配置
LOG_LEVEL=Information
LOG_MAX_FILE_SIZE=50
LOG_MAX_FILE_COUNT=5
```

---

## ✅ 服务验证

### 1. 健康检查

```bash
# 检查API服务健康状态
curl http://localhost:8080/health

# 预期响应
{
  "status": "Healthy",
  "timestamp": "2024-01-01T00:00:00Z",
  "services": {
    "database": "Healthy",
    "cache": "Healthy"
  }
}
```

### 2. API端点测试

```bash
# 获取所有商品
curl http://localhost:8080/api/products

# 获取所有地址
curl http://localhost:8080/api/addresses

# 获取运费配置
curl http://localhost:8080/api/shipping/rates
```

### 3. Swagger文档

访问 http://localhost:8080/swagger 查看API文档

### 4. 数据库连接测试

```bash
# 连接到PostgreSQL
docker exec -it llxrice_db psql -U llxrice_user -d llxrice

# 查看表结构
\dt

# 查看数据
SELECT COUNT(*) FROM Products;
SELECT COUNT(*) FROM Addresses;
SELECT COUNT(*) FROM Orders;
```

### 5. Redis连接测试

```bash
# 连接到Redis
docker exec -it llxrice_redis redis-cli

# 测试连接
ping

# 查看键
keys *

# 测试缓存
set test_key "test_value"
get test_key
```

---

## 🔍 故障排除

### 常见问题及解决方案

#### 1. 服务启动失败

**问题**: 容器启动失败
```bash
# 查看容器日志
docker-compose logs api

# 查看容器状态
docker-compose ps

# 重启服务
docker-compose restart api
```

**解决方案**:
- 检查环境变量配置
- 检查端口占用
- 检查Docker服务状态

#### 2. 数据库连接失败

**问题**: 无法连接到数据库
```bash
# 检查数据库容器状态
docker-compose logs postgres

# 检查网络连接
docker network ls
docker network inspect llxrice_llxrice_network
```

**解决方案**:
- 检查数据库密码配置
- 检查网络配置
- 重启数据库服务

#### 3. Redis连接失败

**问题**: 无法连接到Redis
```bash
# 检查Redis容器状态
docker-compose logs redis

# 测试Redis连接
docker exec -it llxrice_redis redis-cli ping
```

**解决方案**:
- 检查Redis密码配置
- 检查Redis内存配置
- 重启Redis服务

#### 4. 端口占用问题

**问题**: 端口已被占用
```bash
# 查看端口占用
netstat -tulpn | grep :8080  # Linux
netstat -ano | findstr :8080  # Windows

# 停止占用端口的进程
sudo kill -9 <PID>  # Linux
taskkill /PID <PID> /F  # Windows
```

#### 5. 内存不足

**问题**: 容器内存不足
```bash
# 查看容器资源使用
docker stats

# 调整内存限制
# 编辑docker-compose.yml
deploy:
  resources:
    limits:
      memory: 1G  # 增加内存限制
```

### 日志查看

#### 查看所有服务日志
```bash
docker-compose logs -f
```

#### 查看特定服务日志
```bash
docker-compose logs -f api
docker-compose logs -f postgres
docker-compose logs -f redis
```

#### 查看应用日志文件
```bash
# 查看日志目录
ls -la logs/

# 查看最新日志
tail -f logs/app-*.log
```

---

## 🔧 维护指南

### 日常维护

#### 1. 服务状态检查
```bash
# 检查服务状态
docker-compose ps

# 检查资源使用
docker stats

# 检查磁盘使用
df -h
```

#### 2. 日志清理
```bash
# 清理Docker日志
docker system prune -f

# 清理应用日志
find logs/ -name "*.log" -mtime +7 -delete
```

#### 3. 数据备份
```bash
# 备份数据库
docker exec llxrice_db pg_dump -U llxrice_user llxrice > backup_$(date +%Y%m%d).sql

# 备份Redis数据
docker exec llxrice_redis redis-cli --rdb /data/backup_$(date +%Y%m%d).rdb
```

### 更新部署

#### 1. 更新代码
```bash
# 拉取最新代码
git pull origin main

# 重新构建镜像
docker-compose build --no-cache

# 重启服务
docker-compose up -d
```

#### 2. 数据库迁移
```bash
# 运行数据库迁移
docker-compose exec api dotnet ef database update
```

#### 3. 配置更新
```bash
# 更新环境变量
nano .env

# 重启服务
docker-compose restart
```

### 监控和告警

#### 1. 健康检查监控
```bash
# 设置定时健康检查
crontab -e

# 添加以下行（每5分钟检查一次）
*/5 * * * * curl -f http://localhost:8080/health || echo "Service down" | mail -s "Service Alert" admin@example.com
```

#### 2. 性能监控
```bash
# 运行性能测试
.\scripts\test-performance.ps1 -ConcurrentUsers 10 -TestDuration 60

# 查看性能报告
cat performance_report.json
```

#### 3. 日志监控
```bash
# 监控错误日志
tail -f logs/app-*.log | grep ERROR

# 监控慢请求
tail -f logs/app-*.log | grep "Slow request"
```

---

## 📞 技术支持

### 联系方式
- **技术支持**: support@llxrice.com
- **文档更新**: docs@llxrice.com
- **紧急联系**: emergency@llxrice.com

### 相关文档
- [API文档](http://localhost:8080/swagger)
- [开发指南](doc/后端服务开发计划.md)
- [技术方案](doc/后端服务设计方案.md)
- [第四阶段总结](第四阶段完成总结.md)

### 版本信息
- **当前版本**: v1.0.0
- **最后更新**: 2024-01-01
- **兼容性**: .NET 8, PostgreSQL 16, Redis 7.2

---

## 🎯 总结

本部署说明文档提供了完整的部署流程，包括：

1. ✅ **系统要求** - 硬件和软件要求
2. ✅ **环境准备** - Docker安装和项目准备
3. ✅ **快速部署** - 一键部署脚本使用
4. ✅ **详细步骤** - 手动部署流程
5. ✅ **配置说明** - 详细的配置参数
6. ✅ **服务验证** - 部署后的验证步骤
7. ✅ **故障排除** - 常见问题解决方案
8. ✅ **维护指南** - 日常维护和更新

按照本文档的步骤，您可以成功部署林龍香大米商城后端服务到生产环境。如有任何问题，请参考故障排除部分或联系技术支持。
