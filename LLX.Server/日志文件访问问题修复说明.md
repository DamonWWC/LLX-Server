# æ—¥å¿—æ–‡ä»¶è®¿é—®é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
Failed to write log: The process cannot access the file 'E:\èµ„æ–™\å­¦ä¹ ä»£ç \LLX.Server\LLX.Server\logs\info-2025-10-22.log' because it is being used by another process.
```

### é—®é¢˜åŸå› 

åœ¨ `FileLogger.cs` ä¸­ï¼Œæ–‡ä»¶æ‰“å¼€æ—¶ä½¿ç”¨çš„å…±äº«æ¨¡å¼ä¸æ­£ç¡®ï¼š

```csharp
// åŸæ¥çš„ä»£ç ï¼ˆæœ‰é—®é¢˜ï¼‰
var stream = new FileStream(filePath, FileMode.Append, FileAccess.Write, FileShare.Read);
```

**é—®é¢˜åˆ†æ**ï¼š
- `FileShare.Read` è¡¨ç¤ºå…è®¸å…¶ä»–è¿›ç¨‹**è¯»å–**æ–‡ä»¶ï¼Œä½†ä¸å…è®¸å…¶ä»–è¿›ç¨‹**å†™å…¥**
- å½“æœ‰å¤šä¸ªåº”ç”¨ç¨‹åºå®ä¾‹æˆ–åå°JobåŒæ—¶è¿è¡Œæ—¶ï¼Œå®ƒä»¬éƒ½å°è¯•å†™å…¥åŒä¸€ä¸ªæ—¥å¿—æ–‡ä»¶
- ç”±äºæ–‡ä»¶å…±äº«æ¨¡å¼é™åˆ¶ï¼Œç¬¬äºŒä¸ªè¿›ç¨‹æ— æ³•è·å–å†™å…¥æƒé™ï¼Œå¯¼è‡´"æ–‡ä»¶è¢«å…¶ä»–è¿›ç¨‹ä½¿ç”¨"çš„é”™è¯¯

### è§¦å‘åœºæ™¯

1. **å¤šä¸ªåº”ç”¨å®ä¾‹åŒæ—¶è¿è¡Œ**
   - ä½¿ç”¨ `dotnet run` å¯åŠ¨ä¸€ä¸ªå®ä¾‹
   - åŒæ—¶åœ¨åå°Jobä¸­è¿è¡Œå¦ä¸€ä¸ªå®ä¾‹
   - ä¸¤ä¸ªå®ä¾‹éƒ½å°è¯•å†™å…¥åŒä¸€ä¸ªæ—¥å¿—æ–‡ä»¶

2. **å¼€å‘è°ƒè¯•ç¯å¢ƒ**
   - Visual Studio è°ƒè¯•æ¨¡å¼è¿è¡Œ
   - åŒæ—¶ä½¿ç”¨å‘½ä»¤è¡Œè¿è¡Œå¦ä¸€ä¸ªå®ä¾‹

3. **å®¹å™¨åŒ–éƒ¨ç½²**
   - Dockerå®¹å™¨é‡å¯æ—¶æ—§è¿›ç¨‹æœªå®Œå…¨ç»“æŸ
   - æ–°æ—§è¿›ç¨‹åŒæ—¶è®¿é—®æ—¥å¿—æ–‡ä»¶

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

ä¿®æ”¹ `LLX.Server/Logging/FileLogger.cs` ç¬¬100è¡Œï¼š

```csharp
// ä¿®å¤åçš„ä»£ç 
var stream = new FileStream(filePath, FileMode.Append, FileAccess.Write, FileShare.ReadWrite);
```

**ä¿®å¤è¯´æ˜**ï¼š
- å°† `FileShare.Read` æ”¹ä¸º `FileShare.ReadWrite`
- `FileShare.ReadWrite` å…è®¸å…¶ä»–è¿›ç¨‹åŒæ—¶**è¯»å–å’Œå†™å…¥**æ–‡ä»¶
- å¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶è¿½åŠ å†…å®¹åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå¤„ç†æ–‡ä»¶é”å®šå’ŒåŒæ­¥

### FileShare æšä¸¾è¯´æ˜

```csharp
public enum FileShare
{
    None = 0,           // ä¸å…è®¸å…¶ä»–è¿›ç¨‹è®¿é—®
    Read = 1,           // å…è®¸å…¶ä»–è¿›ç¨‹è¯»å–
    Write = 2,          // å…è®¸å…¶ä»–è¿›ç¨‹å†™å…¥
    ReadWrite = 3,      // å…è®¸å…¶ä»–è¿›ç¨‹è¯»å†™ï¼ˆRead | Writeï¼‰
    Delete = 4,         // å…è®¸å…¶ä»–è¿›ç¨‹åˆ é™¤
    Inheritable = 16    // å…è®¸å­è¿›ç¨‹ç»§æ‰¿
}
```

---

## ğŸ” ä¿®å¤éªŒè¯

### 1. ç¼–è¯‘é¡¹ç›®

```bash
cd E:\èµ„æ–™\å­¦ä¹ ä»£ç \LLX.Server\LLX.Server
dotnet build --configuration Release
```

### 2. è¿è¡Œæµ‹è¯•

```bash
# å¯åŠ¨ç¬¬ä¸€ä¸ªå®ä¾‹
dotnet run --no-build --configuration Release --urls "http://localhost:5000"

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ç¬¬äºŒä¸ªå®ä¾‹
dotnet run --no-build --configuration Release --urls "http://localhost:5001"

# ä¸¤ä¸ªå®ä¾‹éƒ½åº”è¯¥èƒ½æ­£å¸¸å†™å…¥æ—¥å¿—ï¼Œä¸ä¼šå‡ºç°æ–‡ä»¶è®¿é—®é”™è¯¯
```

### 3. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶

```bash
# æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
Get-Content logs\info-2025-10-22.log -Tail 20

# åº”è¯¥èƒ½çœ‹åˆ°æ¥è‡ªä¸¤ä¸ªå®ä¾‹çš„æ—¥å¿—ï¼Œæ²¡æœ‰é”™è¯¯ä¿¡æ¯
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ—¥å¿—æ–‡ä»¶å…±äº«ç­–ç•¥

å¯¹äºæ—¥å¿—æ–‡ä»¶ï¼Œæ¨èçš„æ–‡ä»¶å…±äº«æ¨¡å¼ï¼š

```csharp
// âœ… æ¨èï¼šå…è®¸å¤šè¿›ç¨‹è¯»å†™
FileShare.ReadWrite

// âŒ ä¸æ¨èï¼šåªå…è®¸è¯»å–
FileShare.Read

// âŒ ä¸æ¨èï¼šå®Œå…¨ç‹¬å 
FileShare.None
```

### 2. æ—¥å¿—æ–‡ä»¶å‘½åç­–ç•¥

ä¸ºé¿å…æ–‡ä»¶å†²çªï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹ç­–ç•¥ï¼š

**æŒ‰æ—¥æœŸåˆ†å‰²**ï¼ˆå½“å‰å®ç°ï¼‰ï¼š
```csharp
var fileName = $"{levelName}-{date}.log";  // info-2025-10-22.log
```

**æŒ‰è¿›ç¨‹IDåˆ†å‰²**ï¼ˆå¯é€‰ï¼‰ï¼š
```csharp
var processId = Process.GetCurrentProcess().Id;
var fileName = $"{levelName}-{date}-{processId}.log";  // info-2025-10-22-12345.log
```

**æŒ‰åº”ç”¨å®ä¾‹åˆ†å‰²**ï¼ˆå¯é€‰ï¼‰ï¼š
```csharp
var instanceId = Environment.GetEnvironmentVariable("INSTANCE_ID") ?? "default";
var fileName = $"{levelName}-{date}-{instanceId}.log";  // info-2025-10-22-instance1.log
```

### 3. æ—¥å¿—å†™å…¥ä¼˜åŒ–

```csharp
// âœ… ä½¿ç”¨ç¼“å†²åŒºï¼Œå‡å°‘ç£ç›˜I/O
var stream = new FileStream(filePath, FileMode.Append, FileAccess.Write, FileShare.ReadWrite, bufferSize: 4096);

// âœ… ä½¿ç”¨AutoFlushç¡®ä¿æ—¥å¿—åŠæ—¶å†™å…¥
var writer = new StreamWriter(stream, Encoding.UTF8) { AutoFlush = true };

// âœ… ä½¿ç”¨çº¿ç¨‹é”ä¿æŠ¤å†™å…¥æ“ä½œ
lock (_lock)
{
    writer.WriteLine(logEntry);
    writer.Flush();
}
```

### 4. æ—¥å¿—æ–‡ä»¶æ¸…ç†

```csharp
// å®šæœŸæ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶
private void CleanupOldLogsIfNeeded()
{
    if (_options.RetainedFileCountLimit <= 0)
        return;

    var logFiles = Directory.GetFiles(_options.LogDirectory, "*.log")
        .OrderByDescending(f => File.GetCreationTime(f))
        .Skip(_options.RetainedFileCountLimit);

    foreach (var file in logFiles)
    {
        try
        {
            File.Delete(file);
        }
        catch
        {
            // å¿½ç•¥åˆ é™¤å¤±è´¥
        }
    }
}
```

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½è€ƒè™‘

ä½¿ç”¨ `FileShare.ReadWrite` ä¼šæœ‰è½»å¾®çš„æ€§èƒ½å½±å“ï¼š
- æ“ä½œç³»ç»Ÿéœ€è¦å¤„ç†å¤šè¿›ç¨‹åŒæ­¥
- å¯èƒ½ä¼šæœ‰çŸ­æš‚çš„æ–‡ä»¶é”å®šç­‰å¾…

**å½±å“è¯„ä¼°**ï¼š
- âœ… å¯¹äºæ—¥å¿—å†™å…¥ï¼Œæ€§èƒ½å½±å“**å¯ä»¥å¿½ç•¥ä¸è®¡**
- âœ… æ—¥å¿—æœ¬èº«æ˜¯å¼‚æ­¥éå…³é”®æ“ä½œ
- âœ… æ­£ç¡®æ€§å’Œå¯ç”¨æ€§ä¼˜å…ˆäºå¾®å°çš„æ€§èƒ½å·®å¼‚

### 2. å¹¶å‘å®‰å…¨

è™½ç„¶ `FileShare.ReadWrite` å…è®¸å¤šè¿›ç¨‹è®¿é—®ï¼Œä½†ä»éœ€è¦ï¼š
- âœ… åœ¨å•ä¸ªè¿›ç¨‹å†…ä½¿ç”¨ `lock` ä¿æŠ¤å†™å…¥æ“ä½œ
- âœ… ä½¿ç”¨ `FileMode.Append` ç¡®ä¿è¿½åŠ å†™å…¥
- âœ… ä½¿ç”¨ `AutoFlush` ç¡®ä¿æ•°æ®åŠæ—¶å†™å…¥ç£ç›˜

### 3. æ—¥å¿—ä¸¢å¤±é£é™©

åœ¨æç«¯æƒ…å†µä¸‹ï¼ˆå¦‚ç³»ç»Ÿå´©æºƒï¼‰ï¼Œå¯èƒ½ä¼šæœ‰å°‘é‡æ—¥å¿—ä¸¢å¤±ï¼š
- ä½¿ç”¨ `AutoFlush = true` å¯ä»¥æœ€å°åŒ–é£é™©
- å¯¹äºå…³é”®æ—¥å¿—ï¼Œè€ƒè™‘ä½¿ç”¨ä¸“ä¸šæ—¥å¿—æœåŠ¡ï¼ˆå¦‚ Serilog, NLogï¼‰

---

## ğŸ”„ ç›¸å…³æ”¹è¿›å»ºè®®

### 1. ä½¿ç”¨æˆç†Ÿçš„æ—¥å¿—åº“

è€ƒè™‘ä½¿ç”¨æ›´æˆç†Ÿçš„æ—¥å¿—åº“æ›¿ä»£è‡ªå®šä¹‰å®ç°ï¼š

**Serilog**:
```csharp
builder.Host.UseSerilog((context, configuration) =>
{
    configuration
        .ReadFrom.Configuration(context.Configuration)
        .WriteTo.File("logs/log-.txt", 
            rollingInterval: RollingInterval.Day,
            shared: true);  // æ”¯æŒå¤šè¿›ç¨‹å…±äº«
});
```

**NLog**:
```xml
<target name="file" type="File" 
    fileName="logs/${shortdate}.log"
    concurrentWrites="true"    <!-- æ”¯æŒå¹¶å‘å†™å…¥ -->
    keepFileOpen="false" />
```

### 2. é›†ä¸­å¼æ—¥å¿—ç®¡ç†

å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œæ¨èä½¿ç”¨é›†ä¸­å¼æ—¥å¿—ç®¡ç†ï¼š
- **ELK Stack** (Elasticsearch, Logstash, Kibana)
- **Seq** (ç»“æ„åŒ–æ—¥å¿—æœåŠ¡å™¨)
- **Application Insights** (Azure)
- **CloudWatch** (AWS)

### 3. ç»“æ„åŒ–æ—¥å¿—

æ”¹è¿›æ—¥å¿—æ ¼å¼ä¸ºç»“æ„åŒ–æ—¥å¿—ï¼š

```csharp
logger.LogInformation("ç”¨æˆ· {UserId} è®¿é—®äº† {Endpoint}", userId, endpoint);

// è¾“å‡ºJSONæ ¼å¼
{
    "timestamp": "2025-10-22T16:56:43.792Z",
    "level": "Information",
    "message": "ç”¨æˆ· 123 è®¿é—®äº† /api/products",
    "properties": {
        "UserId": 123,
        "Endpoint": "/api/products"
    }
}
```

---

## âœ… æ€»ç»“

### é—®é¢˜æ ¹æº
- æ–‡ä»¶å…±äº«æ¨¡å¼ä½¿ç”¨ `FileShare.Read` å¯¼è‡´å¤šè¿›ç¨‹æ— æ³•åŒæ—¶å†™å…¥æ—¥å¿—

### è§£å†³æ–¹æ¡ˆ
- ä¿®æ”¹ä¸º `FileShare.ReadWrite` å…è®¸å¤šè¿›ç¨‹å…±äº«è®¿é—®

### å½±å“èŒƒå›´
- âœ… æ”¯æŒå¤šä¸ªåº”ç”¨å®ä¾‹åŒæ—¶è¿è¡Œ
- âœ… æ”¯æŒè°ƒè¯•å’Œç”Ÿäº§ç¯å¢ƒåŒæ—¶è¿è¡Œ
- âœ… æ”¯æŒDockerå®¹å™¨å¿«é€Ÿé‡å¯

### éªŒè¯ç»“æœ
- âœ… ç¼–è¯‘æˆåŠŸ
- âœ… è¿è¡Œæ— é”™è¯¯
- âœ… æ—¥å¿—æ­£å¸¸å†™å…¥

---

**ä¿®å¤æ—¶é—´**: 2025-10-22  
**ä¿®å¤æ–‡ä»¶**: `LLX.Server/Logging/FileLogger.cs`  
**ä¿®æ”¹è¡Œæ•°**: ç¬¬100è¡Œ  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡
